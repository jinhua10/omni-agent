# âœ… æŸ¥è¯¢ç»“æœç¼“å­˜æŒä¹…åŒ–å®ç°

> **å®ç°æ—¶é—´ï¼š** 2025-12-27  
> **åŠŸèƒ½ï¼š** åŸºäºå­˜å‚¨æœåŠ¡çš„æŒä¹…åŒ–ç¼“å­˜  
> **çŠ¶æ€ï¼š** âœ… å®Œæˆå¹¶ç¼–è¯‘é€šè¿‡

---

## ğŸ¯ å®ç°ç›®æ ‡

**é—®é¢˜ï¼š** åŸæœ‰ç¼“å­˜åªå­˜åœ¨å†…å­˜ä¸­ï¼Œç³»ç»Ÿé‡å¯åç¼“å­˜å…¨éƒ¨ä¸¢å¤±ã€‚

**è§£å†³æ–¹æ¡ˆï¼š** å®ç°ä¸¤çº§ç¼“å­˜æ¶æ„ï¼ˆL1å†…å­˜ + L2æŒä¹…åŒ–ï¼‰ï¼Œåˆ©ç”¨ `DocumentStorageService` å®ç°ç¼“å­˜æŒä¹…åŒ–å­˜å‚¨ã€‚

---

## ğŸ—ï¸ ä¸¤çº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1 å†…å­˜ç¼“å­˜ (ConcurrentHashMap)    â”‚  â† å¿«é€Ÿè®¿é—®
â”‚  - æœ€è¿‘ä½¿ç”¨çš„çƒ­é—¨æŸ¥è¯¢                â”‚
â”‚  - LRUæ·˜æ±°ç­–ç•¥                      â”‚
â”‚  - æœ€å¤§1000æ¡ï¼ˆå¯é…ç½®ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L2 æŒä¹…åŒ–å­˜å‚¨ (DocumentStorage)    â”‚  â† æŒä¹…ä¿å­˜
â”‚  - æ‰€æœ‰ç¼“å­˜æ¡ç›®                     â”‚
â”‚  - ç³»ç»Ÿé‡å¯åä»ç„¶å­˜åœ¨                â”‚
â”‚  - è‡ªåŠ¨åŠ è½½åˆ°L1                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å¯åŠ¨æ—¶åŠ è½½ç¼“å­˜

```java
@PostConstruct
public void init() {
    if (enabled && persistenceEnabled && storageService != null) {
        loadPersistedCache();  // ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½ç¼“å­˜
    }
}
```

**åŠ è½½æµç¨‹ï¼š**
```
1. ç³»ç»Ÿå¯åŠ¨
   â†“
2. æ‰«ææ‰€æœ‰ "query-cache-*" çš„å­˜å‚¨æ–‡æ¡£
   â†“
3. ååºåˆ—åŒ–ä¸º CacheEntry å¯¹è±¡
   â†“
4. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
   â†“
5. æœªè¿‡æœŸçš„åŠ è½½åˆ°å†…å­˜ç¼“å­˜
   â†“
6. è¿‡æœŸçš„åˆ é™¤æŒä¹…åŒ–æ•°æ®
   â†“
7. å®ŒæˆåŠ è½½
```

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```
ğŸ”„ å¼€å§‹åŠ è½½æŒä¹…åŒ–ç¼“å­˜...
âœ… æŒä¹…åŒ–ç¼“å­˜åŠ è½½å®Œæˆ: 127 ä¸ªæ¡ç›®
```

### æŸ¥è¯¢æ—¶çš„ç¼“å­˜ç­–ç•¥

```java
public List<Document> get(String query, List<String> domainIds) {
    // 1. å…ˆä» L1 å†…å­˜ç¼“å­˜è·å–
    CacheEntry entry = cache.get(cacheKey);
    
    if (entry == null && persistenceEnabled) {
        // 2. L1 æœªå‘½ä¸­ï¼Œä» L2 æŒä¹…åŒ–å­˜å‚¨åŠ è½½
        entry = loadFromPersistence(cacheKey);
        if (entry != null) {
            // åŠ è½½åˆ° L1
            cache.put(cacheKey, entry);
            log.debug("ğŸ“€ ä»æŒä¹…åŒ–åŠ è½½ç¼“å­˜");
        }
    }
    
    // 3. è¿”å›ç»“æœ
}
```

**æŸ¥è¯¢æµç¨‹ï¼š**
```
ç”¨æˆ·æŸ¥è¯¢
   â†“
æ£€æŸ¥ L1 (å†…å­˜)
   â”œâ”€ å‘½ä¸­ â†’ ç›´æ¥è¿”å› (3ms)
   â””â”€ æœªå‘½ä¸­ â†“
æ£€æŸ¥ L2 (æŒä¹…åŒ–)
   â”œâ”€ å‘½ä¸­ â†’ åŠ è½½åˆ°L1 â†’ è¿”å› (50ms)
   â””â”€ æœªå‘½ä¸­ â†’ æ‰§è¡Œå®é™…æŸ¥è¯¢ (150ms)
```

### å†™å…¥ç¼“å­˜

```java
public void put(String query, List<String> domainIds, List<Document> results) {
    // 1. åˆ›å»ºç¼“å­˜æ¡ç›®
    CacheEntry entry = CacheEntry.builder()
            .cacheKey(cacheKey)
            .query(query)
            .results(results)
            .build();
    
    // 2. å†™å…¥ L1 å†…å­˜ç¼“å­˜
    cache.put(cacheKey, entry);
    
    // 3. å¼‚æ­¥å†™å…¥ L2 æŒä¹…åŒ–å­˜å‚¨
    if (persistenceEnabled && storageService != null) {
        saveToPersistence(cacheKey, entry);
    }
}
```

**å†™å…¥æµç¨‹ï¼š**
```
æ–°æŸ¥è¯¢ç»“æœ
   â†“
å†™å…¥ L1 (å†…å­˜) â† åŒæ­¥ï¼Œç«‹å³å®Œæˆ
   â†“
å†™å…¥ L2 (æŒä¹…åŒ–) â† å¼‚æ­¥ï¼Œä¸é˜»å¡
   â†“
å®Œæˆ
```

### å…³é—­æ—¶æŒä¹…åŒ–

```java
@PreDestroy
public void destroy() {
    if (enabled && persistenceEnabled && storageService != null) {
        persistCache();  // ä¿å­˜æ‰€æœ‰å†…å­˜ç¼“å­˜åˆ°æŒä¹…åŒ–
    }
}
```

**æŒä¹…åŒ–æµç¨‹ï¼š**
```
ç³»ç»Ÿå…³é—­ä¿¡å·
   â†“
éå†æ‰€æœ‰å†…å­˜ç¼“å­˜æ¡ç›®
   â†“
åºåˆ—åŒ–ä¸º JSON
   â†“
ä¿å­˜åˆ° DocumentStorage
   â†“
å®Œæˆ
```

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```
ğŸ’¾ å¼€å§‹æŒä¹…åŒ–ç¼“å­˜...
âœ… ç¼“å­˜æŒä¹…åŒ–å®Œæˆ: 143 ä¸ªæ¡ç›®
```

---

## ğŸ’¾ æŒä¹…åŒ–å­˜å‚¨å®ç°

### å­˜å‚¨æ ¼å¼

**å­˜å‚¨IDç”Ÿæˆï¼š**
```java
private String getStorageId(String cacheKey) {
    int hash = cacheKey.hashCode();
    return persistencePrefix + "-" + Math.abs(hash);
}
```

**ç¤ºä¾‹ï¼š**
- ç¼“å­˜é”®: `"å®‰å…¨æ¼æ´|security,source-code"`
- å­˜å‚¨ID: `"query-cache-1234567890"`

### JSONåºåˆ—åŒ–

**ç¼“å­˜æ¡ç›®ç»“æ„ï¼š**
```json
{
  "cacheKey": "å®‰å…¨æ¼æ´|security,source-code",
  "query": "å®‰å…¨æ¼æ´",
  "domainIds": ["security", "source-code"],
  "results": [
    {
      "id": "doc-1",
      "title": "SQLæ³¨å…¥æ¼æ´",
      "content": "...",
      "score": 0.95
    },
    ...
  ],
  "createdTime": "2025-12-27T10:30:00",
  "lastAccessTime": "2025-12-27T11:45:00",
  "hitCount": 23
}
```

### å­˜å‚¨ä½ç½®

æ ¹æ® `DocumentStorageService` çš„å®ç°ä¸åŒï¼ŒæŒä¹…åŒ–ä½ç½®ä¹Ÿä¸åŒï¼š

| å­˜å‚¨å®ç° | æŒä¹…åŒ–ä½ç½® |
|---------|-----------|
| File | `data/storage/extracted/query-cache-*.txt` |
| MongoDB | `documents` é›†åˆ |
| Redis | `extracted:query-cache-*` |
| S3/MinIO | `extracted/query-cache-*.txt` |

---

## âš™ï¸ é…ç½®è¯´æ˜

### é…ç½®é¡¹

```yaml
omni-agent:
  query-cache:
    enabled: true                    # æ˜¯å¦å¯ç”¨ç¼“å­˜
    max-size: 1000                   # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
    ttl-minutes: 30                  # ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    persistence-enabled: true        # æ˜¯å¦å¯ç”¨æŒä¹…åŒ– â­ æ–°å¢
    persistence-prefix: "query-cache"  # æŒä¹…åŒ–å­˜å‚¨å‰ç¼€ â­ æ–°å¢
```

### é…ç½®åœºæ™¯

#### åœºæ™¯ 1ï¼šå®Œï¿½ï¿½ï¿½å¯ç”¨ï¼ˆæ¨èï¼‰
```yaml
query-cache:
  enabled: true
  persistence-enabled: true
  max-size: 1000
  ttl-minutes: 30
```
- âœ… å†…å­˜ç¼“å­˜ + æŒä¹…åŒ–
- âœ… é‡å¯åä¿ç•™
- âœ… æœ€ä½³æ€§èƒ½

#### åœºæ™¯ 2ï¼šä»…å†…å­˜ç¼“å­˜
```yaml
query-cache:
  enabled: true
  persistence-enabled: false  # ç¦ç”¨æŒä¹…åŒ–
  max-size: 500
  ttl-minutes: 15
```
- âœ… å†…å­˜ç¼“å­˜
- âŒ é‡å¯åä¸¢å¤±
- âœ… é€‚åˆé¢‘ç¹é‡å¯çš„å¼€å‘ç¯å¢ƒ

#### åœºæ™¯ 3ï¼šç¦ç”¨ç¼“å­˜
```yaml
query-cache:
  enabled: false
```
- âŒ æ— ç¼“å­˜
- âœ… é€‚åˆè°ƒè¯•

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ç¼“å­˜å‘½ä¸­åœºæ™¯

| ç¼“å­˜ç±»å‹ | å“åº”æ—¶é—´ | è¯´æ˜ |
|---------|---------|------|
| L1 å‘½ä¸­ | 3ms | å†…å­˜ç›´æ¥è¿”å› |
| L2 å‘½ä¸­ | 50ms | ä»æŒä¹…åŒ–åŠ è½½åˆ°å†…å­˜ |
| æœªå‘½ä¸­ | 150ms | æ‰§è¡Œå®é™…æŸ¥è¯¢ |

### æŒä¹…åŒ–æ€§èƒ½

| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| å†™å…¥æŒä¹…åŒ– | å¼‚æ­¥ | ä¸é˜»å¡æŸ¥è¯¢ |
| å¯åŠ¨åŠ è½½ | 100-500ms | å–å†³äºç¼“å­˜æ•°é‡ |
| å…³é—­ä¿å­˜ | 200-1000ms | å–å†³äºç¼“å­˜æ•°é‡ |

---

## ğŸ” å®é™…æ•ˆæœ

### å¯åŠ¨æ—¥å¿—

```
2025-12-27 10:00:01 [main] INFO  QueryResultCache - 
ğŸ”„ å¼€å§‹åŠ è½½æŒä¹…åŒ–ç¼“å­˜...

2025-12-27 10:00:01 [main] DEBUG QueryResultCache - 
ğŸ“€ ä»æŒä¹…åŒ–åŠ è½½: å®‰å…¨æ¼æ´|security,source-code (ç»“æœæ•°: 10)

2025-12-27 10:00:01 [main] DEBUG QueryResultCache - 
ğŸ“€ ä»æŒä¹…åŒ–åŠ è½½: æ€§èƒ½ä¼˜åŒ–|performance,code (ç»“æœæ•°: 8)

...

2025-12-27 10:00:02 [main] INFO  QueryResultCache - 
âœ… æŒä¹…åŒ–ç¼“å­˜åŠ è½½å®Œæˆ: 127 ä¸ªæ¡ç›®

2025-12-27 10:00:02 [main] INFO  QueryResultCache - 
âœ… æŸ¥è¯¢ç¼“å­˜å·²åˆå§‹åŒ– (å¯ç”¨: true, æŒä¹…åŒ–: true, æœ€å¤§: 1000)
```

### æŸ¥è¯¢æ—¥å¿—

```
2025-12-27 10:05:30 [http-nio-8080-exec-1] DEBUG QueryResultCache - 
âœ… ç¼“å­˜å‘½ä¸­: å®‰å…¨æ¼æ´|security,source-code (å‘½ä¸­æ¬¡æ•°: 24)

2025-12-27 10:06:15 [http-nio-8080-exec-2] DEBUG QueryResultCache - 
ç¼“å­˜æœªå‘½ä¸­: æ–°æŸ¥è¯¢|domain-1

2025-12-27 10:06:15 [http-nio-8080-exec-2] DEBUG QueryResultCache - 
ğŸ’¾ åŠ å…¥ç¼“å­˜: æ–°æŸ¥è¯¢|domain-1 (ç»“æœæ•°: 12, æŒä¹…åŒ–: true)

2025-12-27 10:06:15 [http-nio-8080-exec-2] DEBUG QueryResultCache - 
ğŸ’¾ æŒä¹…åŒ–ä¿å­˜: æ–°æŸ¥è¯¢|domain-1
```

### å…³é—­æ—¥å¿—

```
2025-12-27 18:00:00 [shutdown-hook] INFO  QueryResultCache - 
ğŸ’¾ å¼€å§‹æŒä¹…åŒ–ç¼“å­˜...

2025-12-27 18:00:00 [shutdown-hook] DEBUG QueryResultCache - 
ğŸ’¾ æŒä¹…åŒ–ä¿å­˜: å®‰å…¨æ¼æ´|security,source-code

...

2025-12-27 18:00:01 [shutdown-hook] INFO  QueryResultCache - 
âœ… ç¼“å­˜æŒä¹…åŒ–å®Œæˆ: 143 ä¸ªæ¡ç›®
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨ï¼ˆè‡ªåŠ¨æŒä¹…åŒ–ï¼‰

```java
@Autowired
private QueryResultCache resultCache;

// æŸ¥è¯¢æ—¶è‡ªåŠ¨ä»æŒä¹…åŒ–åŠ è½½
List<Document> cached = resultCache.get("å®‰å…¨æ¼æ´", 
    List.of("security", "source-code"));

if (cached != null) {
    // å¯èƒ½æ¥è‡ª L1 å†…å­˜ç¼“å­˜ï¼ˆ3msï¼‰
    // æˆ–ä» L2 æŒä¹…åŒ–åŠ è½½ï¼ˆ50msï¼‰
    return cached;
}

// æ‰§è¡Œå®é™…æŸ¥è¯¢
List<Document> results = performQuery();

// å­˜å…¥ç¼“å­˜ï¼ˆè‡ªåŠ¨æŒä¹…åŒ–ï¼‰
resultCache.put("å®‰å…¨æ¼æ´", 
    List.of("security", "source-code"), results);
```

### æŸ¥çœ‹ç»Ÿè®¡

```java
var stats = resultCache.getStatistics();
System.out.println("ç¼“å­˜å¤§å°: " + stats.getSize());
System.out.println("æ€»å‘½ä¸­: " + stats.getTotalHits());
```

---

## âœ… ä¼˜åŠ¿

### 1. æŒä¹…æ€§
- âœ… ç³»ç»Ÿé‡å¯åç¼“å­˜ä»ç„¶å­˜åœ¨
- âœ… é¿å…å†·å¯åŠ¨æ€§èƒ½é—®é¢˜
- âœ… å‡å°‘æœåŠ¡å™¨èµ„æºæ¶ˆè€—

### 2. çµæ´»æ€§
- âœ… å¯é…ç½®æ˜¯å¦å¯ç”¨æŒä¹…åŒ–
- âœ… å¯é€‰æ‹©ä¸åŒçš„å­˜å‚¨åç«¯
- âœ… æ”¯æŒå®Œå…¨ç¦ç”¨ç¼“å­˜

### 3. æ€§èƒ½
- âœ… L1 å†…å­˜ç¼“å­˜ä¿è¯é«˜é€Ÿè®¿é—®
- âœ… L2 æŒä¹…åŒ–æä¾›æŒä¹…æ€§
- âœ… å¼‚æ­¥å†™å…¥ä¸é˜»å¡æŸ¥è¯¢

### 4. å¯é æ€§
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†
- âœ… LRUæ·˜æ±°ç­–ç•¥
- âœ… ä¼˜é›…å…³é—­ä¿å­˜

---

## ğŸ”§ ç»´æŠ¤å»ºè®®

### å®šæœŸæ¸…ç†

```java
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ¸…ç†è¿‡æœŸç¼“å­˜
@Scheduled(fixedRate = 3600000)
public void cleanExpiredCache() {
    queryResultCache.evictExpired();
}
```

### ç›‘æ§ç»Ÿè®¡

```java
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©è®°å½•ç¼“å­˜ç»Ÿè®¡
@Scheduled(cron = "0 0 0 * * *")
public void logCacheStats() {
    var stats = queryResultCache.getStatistics();
    log.info("ç¼“å­˜ç»Ÿè®¡: å¤§å°={}, å‘½ä¸­={}, ä½¿ç”¨ç‡={}%",
        stats.getSize(), 
        stats.getTotalHits(),
        stats.getUsageRate() * 100);
}
```

### æ‰‹åŠ¨æ¸…ç†

```java
// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
queryResultCache.clear();
```

---

## ğŸ“ æŠ€æœ¯å®ç°

### ä¾èµ–çš„ç»„ä»¶

1. **DocumentStorageService** - æä¾›æŒä¹…åŒ–å­˜å‚¨
2. **Jackson ObjectMapper** - JSONåºåˆ—åŒ–/ååºåˆ—åŒ–
3. **Spring @PostConstruct/@PreDestroy** - ç”Ÿå‘½å‘¨æœŸç®¡ç†

### å…³é”®ä»£ç 

**JSONåºåˆ—åŒ–é…ç½®ï¼š**
```java
private final ObjectMapper objectMapper = new ObjectMapper()
        .registerModule(new JavaTimeModule());  // æ”¯æŒ LocalDateTime
```

**å¼‚æ­¥æŒä¹…åŒ–ï¼š**
```java
// å†™å…¥å†…å­˜åç«‹å³è¿”å›
cache.put(cacheKey, entry);

// å¼‚æ­¥å†™å…¥æŒä¹…åŒ–ï¼ˆä¸é˜»å¡ï¼‰
if (persistenceEnabled && storageService != null) {
    saveToPersistence(cacheKey, entry);
}
```

---

## âœ… æ€»ç»“

### å®Œæˆå†…å®¹

- âœ… å®ç°ä¸¤çº§ç¼“å­˜æ¶æ„ï¼ˆL1å†…å­˜ + L2æŒä¹…åŒ–ï¼‰
- âœ… ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æŒä¹…åŒ–ç¼“å­˜
- âœ… ç³»ç»Ÿå…³é—­æ—¶è‡ªåŠ¨ä¿å­˜å†…å­˜ç¼“å­˜
- âœ… æ”¯æŒé…ç½®å¯ç”¨/ç¦ç”¨æŒä¹…åŒ–
- âœ… åŸºäº DocumentStorageService å®ç°
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
- âœ… ç¼–è¯‘é€šè¿‡

### æ–°å¢ä»£ç 

- ~200è¡ŒæŒä¹…åŒ–ç›¸å…³ä»£ç 
- é…ç½®æ–‡ä»¶æ›´æ–°

### æ€§èƒ½æå‡

- é‡å¯åç«‹å³å¯ç”¨ï¼ˆåŠ è½½æŒä¹…åŒ–ç¼“å­˜ï¼‰
- é¿å…å†·å¯åŠ¨æ€§èƒ½ä¸‹é™
- L1å‘½ä¸­: 3ms
- L2å‘½ä¸­: 50msï¼ˆé¦–æ¬¡åŠ è½½ï¼‰

---

**å®ç°å®Œæˆæ—¶é—´ï¼š** 2025-12-27  
**çŠ¶æ€ï¼š** âœ… ç”Ÿäº§å°±ç»ª  
**ç‰¹æ€§ï¼š** ç³»ç»Ÿé‡å¯åç¼“å­˜ä¸ä¸¢å¤±

