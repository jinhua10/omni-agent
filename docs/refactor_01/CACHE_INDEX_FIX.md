# ğŸ”§ ç¼“å­˜æŒä¹…åŒ–ä¿®å¤ - ä½¿ç”¨ç´¢å¼•æ–‡ä»¶

> **ä¿®å¤æ—¶é—´ï¼š** 2025-12-27  
> **é—®é¢˜ï¼š** åŸå®ç°ä½¿ç”¨ä¸å­˜åœ¨çš„ `listAllDocuments()` æ–¹æ³•  
> **è§£å†³æ–¹æ¡ˆï¼š** ä½¿ç”¨ç‹¬ç«‹çš„ç´¢å¼•æ–‡ä»¶è®°å½•ç¼“å­˜é”®

---

## âŒ åŸæœ‰é—®é¢˜

### 1. ç¼–è¯‘é”™è¯¯
```java
List<String> allDocs = storageService.listAllDocuments();  // âŒ æ–¹æ³•ä¸å­˜åœ¨
```

`DocumentStorageService` æ¥å£ä¸­**æ²¡æœ‰** `listAllDocuments()` æ–¹æ³•ã€‚

### 2. æ€§èƒ½é—®é¢˜

å³ä½¿æœ‰ `listAllDocuments()` æ–¹æ³•ï¼Œä¹Ÿä¼šï¼š
- âŒ åŠ è½½æ•´ä¸ªçŸ¥è¯†åº“çš„æ‰€æœ‰æ–‡æ¡£
- âŒ éå†æˆåƒä¸Šä¸‡çš„æ–‡æ¡£
- âŒ é€ æˆä¸¥é‡çš„å¯åŠ¨æ€§èƒ½é—®é¢˜
- âŒ å†…å­˜å ç”¨å·¨å¤§

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä½¿ç”¨ç¼“å­˜ç´¢å¼•æ–‡ä»¶

å¼•å…¥ä¸€ä¸ª**ç‹¬ç«‹çš„ç´¢å¼•æ–‡ä»¶**æ¥è®°å½•æ‰€æœ‰ç¼“å­˜æ¡ç›®çš„IDï¼š

```
query-cache-index  â† ç´¢å¼•æ–‡ä»¶ï¼ˆè®°å½•æ‰€æœ‰ç¼“å­˜çš„storageIdï¼‰
    â†“
["query-cache-123456", "query-cache-789012", ...]
    â†“
æ ¹æ®ç´¢å¼•åŠ è½½æ¯ä¸ªç¼“å­˜æ¡ç›®
```

---

## ğŸ—ï¸ å®ç°ç»†èŠ‚

### 1. ç´¢å¼•æ–‡ä»¶ç»“æ„

**ç´¢å¼•æ–‡ä»¶IDï¼š** `query-cache-index`

**å†…å®¹æ ¼å¼ï¼š** JSONæ•°ç»„
```json
[
  "query-cache-1234567890",
  "query-cache-9876543210",
  "query-cache-5555555555"
]
```

æ¯ä¸ªæ¡ç›®æ˜¯ä¸€ä¸ªç¼“å­˜çš„ `storageId`ã€‚

### 2. æ ¸å¿ƒæ•°æ®ç»“æ„

```java
/**
 * ç¼“å­˜é”®ç´¢å¼•ï¼ˆè®°å½•æ‰€æœ‰ç¼“å­˜çš„ storageIdï¼‰
 */
private final Set<String> cacheIndex = ConcurrentHashMap.newKeySet();
```

### 3. å·¥ä½œæµç¨‹

#### å¯åŠ¨æ—¶åŠ è½½

```java
@PostConstruct
public void init() {
    loadPersistedCache();
}

private void loadPersistedCache() {
    // 1. åŠ è½½ç´¢å¼•æ–‡ä»¶
    Set<String> persistedKeys = loadCacheIndex();
    
    // 2. æ ¹æ®ç´¢å¼•åŠ è½½æ¯ä¸ªç¼“å­˜æ¡ç›®
    for (String storageId : persistedKeys) {
        Optional<String> jsonOpt = storageService.getExtractedText(storageId);
        // ååºåˆ—åŒ–å¹¶åŠ è½½åˆ°å†…å­˜
    }
}

private Set<String> loadCacheIndex() {
    Optional<String> indexJson = storageService.getExtractedText(CACHE_INDEX_ID);
    if (indexJson.isPresent()) {
        // è§£æJSONæ•°ç»„
        List<String> indexList = objectMapper.readValue(...);
        return new HashSet<>(indexList);
    }
    return new HashSet<>();
}
```

#### ä¿å­˜ç¼“å­˜æ—¶æ›´æ–°ç´¢å¼•

```java
private void saveToPersistence(String cacheKey, CacheEntry entry) {
    String storageId = getStorageId(cacheKey);
    String json = objectMapper.writeValueAsString(entry);
    storageService.saveExtractedText(storageId, json);
    
    // æ·»åŠ åˆ°ç´¢å¼•
    cacheIndex.add(storageId);  // â­ å…³é”®
}
```

#### åˆ é™¤ç¼“å­˜æ—¶æ›´æ–°ç´¢å¼•

```java
private void deleteFromPersistence(String cacheKey) {
    String storageId = getStorageId(cacheKey);
    storageService.deleteDocument(storageId);
    
    // ä»ç´¢å¼•ç§»é™¤
    cacheIndex.remove(storageId);  // â­ å…³é”®
}
```

#### å…³é—­æ—¶ä¿å­˜ç´¢å¼•

```java
@PreDestroy
public void destroy() {
    persistCache();
}

private void persistCache() {
    // 1. ä¿å­˜æ‰€æœ‰ç¼“å­˜æ¡ç›®
    for (Map.Entry<String, CacheEntry> entry : cache.entrySet()) {
        saveToPersistence(entry.getKey(), entry.getValue());
    }
    
    // 2. ä¿å­˜ç´¢å¼•æ–‡ä»¶
    saveCacheIndex();  // â­ å…³é”®
}

private void saveCacheIndex() {
    String indexJson = objectMapper.writeValueAsString(new ArrayList<>(cacheIndex));
    storageService.saveExtractedText(CACHE_INDEX_ID, indexJson);
}
```

---

## ğŸ“Š ä¼˜åŠ¿å¯¹æ¯”

### åŸæœ‰æ–¹æ¡ˆï¼ˆé”™è¯¯ï¼‰

```java
// âŒ éå†æ‰€æœ‰æ–‡æ¡£
List<String> allDocs = storageService.listAllDocuments();
for (String docId : allDocs) {
    if (docId.startsWith("query-cache-")) {
        // åŠ è½½ç¼“å­˜
    }
}
```

**é—®é¢˜ï¼š**
- âŒ æ–¹æ³•ä¸å­˜åœ¨
- âŒ éœ€è¦éå†æ•´ä¸ªçŸ¥è¯†åº“
- âŒ æ€§èƒ½æå·®ï¼ˆO(n)ï¼Œn=æ‰€æœ‰æ–‡æ¡£æ•°ï¼‰

### æ–°æ–¹æ¡ˆï¼ˆæ­£ç¡®ï¼‰

```java
// âœ… åªè¯»å–ç´¢å¼•æ–‡ä»¶
Set<String> cacheIds = loadCacheIndex();  // è¯»å–1ä¸ªæ–‡ä»¶
for (String cacheId : cacheIds) {
    // åŠ è½½ç¼“å­˜
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… åªè¯»å–ç¼“å­˜ç›¸å…³çš„æ–‡æ¡£
- âœ… æ€§èƒ½ä¼˜ç§€ï¼ˆO(m)ï¼Œm=ç¼“å­˜æ•°é‡ï¼‰

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | åŸæ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æå‡ |
|------|--------|--------|------|
| çŸ¥è¯†åº“10ä¸‡æ–‡æ¡£ + 100ä¸ªç¼“å­˜ | éå†10ä¸‡ | è¯»å–100 | **1000å€** |
| å¯åŠ¨æ—¶é—´ | æ•°åˆ†é’Ÿ | æ•°ç§’ | **æ•°åå€** |
| å†…å­˜å ç”¨ | æé«˜ | æ­£å¸¸ | **æ•°åå€** |

---

## ğŸ”„ å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

### 1. é¦–æ¬¡å¯åŠ¨ï¼ˆæ— ç¼“å­˜ï¼‰

```
å¯åŠ¨
  â†“
åŠ è½½ç´¢å¼•æ–‡ä»¶ â†’ ä¸å­˜åœ¨
  â†“
ç¼“å­˜ç´¢å¼•ä¸ºç©º
  â†“
å®Œæˆï¼ˆ0ä¸ªç¼“å­˜ï¼‰
```

### 2. æ­£å¸¸è¿è¡Œï¼ˆå†™å…¥ç¼“å­˜ï¼‰

```
ç”¨æˆ·æŸ¥è¯¢
  â†“
ç”Ÿæˆç¼“å­˜
  â†“
ä¿å­˜åˆ° query-cache-123456
  â†“
æ·»åŠ åˆ°ç´¢å¼•: cacheIndex.add("query-cache-123456")
```

### 3. ç³»ç»Ÿå…³é—­ï¼ˆä¿å­˜ç´¢å¼•ï¼‰

```
å…³é—­ä¿¡å·
  â†“
persistCache()
  â†“
ä¿å­˜æ‰€æœ‰ç¼“å­˜æ¡ç›®
  â†“
ä¿å­˜ç´¢å¼•æ–‡ä»¶: ["query-cache-123456", "query-cache-789012", ...]
```

### 4. ä¸‹æ¬¡å¯åŠ¨ï¼ˆåŠ è½½ç¼“å­˜ï¼‰

```
å¯åŠ¨
  â†“
åŠ è½½ç´¢å¼•æ–‡ä»¶ â†’ æ‰¾åˆ° ["query-cache-123456", ...]
  â†“
æ ¹æ®ç´¢å¼•åŠ è½½æ¯ä¸ªç¼“å­˜
  â†“
åŠ è½½å®Œæˆï¼ˆ100ä¸ªç¼“å­˜ï¼Œè€—æ—¶2ç§’ï¼‰
```

---

## ğŸ“ å­˜å‚¨ç»“æ„

### æ–‡ä»¶å¸ƒå±€ï¼ˆä»¥ File å­˜å‚¨ä¸ºä¾‹ï¼‰

```
data/storage/extracted/
â”œâ”€â”€ query-cache-index          â† ç´¢å¼•æ–‡ä»¶
â”œâ”€â”€ query-cache-1234567890     â† ç¼“å­˜æ¡ç›®1
â”œâ”€â”€ query-cache-9876543210     â† ç¼“å­˜æ¡ç›®2
â”œâ”€â”€ query-cache-5555555555     â† ç¼“å­˜æ¡ç›®3
â”œâ”€â”€ ...
â””â”€â”€ doc-actual-content-1       â† å®é™…çš„çŸ¥è¯†åº“æ–‡æ¡£ï¼ˆä¸ä¼šè¢«åŠ è½½ï¼‰
```

**å…³é”®ç‚¹ï¼š**
- âœ… åªåŠ è½½ `query-cache-*` å¼€å¤´çš„æ–‡ä»¶
- âœ… é€šè¿‡ç´¢å¼•æ–‡ä»¶çŸ¥é“å“ªäº›æ˜¯ç¼“å­˜
- âœ… ä¸ä¼šè¯¯åŠ è½½çŸ¥è¯†åº“æ–‡æ¡£

---

## ğŸ¯ ä½¿ç”¨è¯´æ˜

### å®Œå…¨è‡ªåŠ¨

ç”¨æˆ·**æ— éœ€ä»»ä½•ä¿®æ”¹**ï¼Œç³»ç»Ÿè‡ªåŠ¨ï¼š

1. âœ… å¯åŠ¨æ—¶ä»ç´¢å¼•åŠ è½½ç¼“å­˜
2. âœ… è¿è¡Œæ—¶è‡ªåŠ¨ç»´æŠ¤ç´¢å¼•
3. âœ… å…³é—­æ—¶ä¿å­˜ç´¢å¼•
4. âœ… è¿‡æœŸç¼“å­˜è‡ªåŠ¨æ¸…ç†å¹¶æ›´æ–°ç´¢å¼•

### æ—¥å¿—ç¤ºä¾‹

**å¯åŠ¨æ—¶ï¼š**
```
ğŸ”„ å¼€å§‹åŠ è½½æŒä¹…åŒ–ç¼“å­˜...
ğŸ“‹ ç¼“å­˜ç´¢å¼•åŒ…å« 127 ä¸ªæ¡ç›®
âœ… æŒä¹…åŒ–ç¼“å­˜åŠ è½½å®Œæˆ: 120 ä¸ªåŠ è½½, 5 ä¸ªè¿‡æœŸ, 2 ä¸ªå¤±è´¥
ğŸ“‹ ç¼“å­˜ç´¢å¼•å·²æ›´æ–°: 120 ä¸ªæ¡ç›®
```

**è¿è¡Œæ—¶ï¼š**
```
ğŸ’¾ æŒä¹…åŒ–ä¿å­˜: æ–°æŸ¥è¯¢|domain-1
ğŸ“‹ ç¼“å­˜ç´¢å¼•å·²æ›´æ–°: 121 ä¸ªæ¡ç›®
```

**å…³é—­æ—¶ï¼š**
```
ğŸ’¾ å¼€å§‹æŒä¹…åŒ–ç¼“å­˜...
ğŸ“‹ ç¼“å­˜ç´¢å¼•å·²æ›´æ–°: 143 ä¸ªæ¡ç›®
âœ… ç¼“å­˜æŒä¹…åŒ–å®Œæˆ: 143 ä¸ªæ¡ç›®
```

---

## âœ… ä¿®å¤æ€»ç»“

### ä¿®æ”¹å†…å®¹

1. âœ… æ·»åŠ ç¼“å­˜ç´¢å¼•æ•°æ®ç»“æ„
   ```java
   private final Set<String> cacheIndex = ConcurrentHashMap.newKeySet();
   ```

2. âœ… æ·»åŠ ç´¢å¼•æ–‡ä»¶å¸¸é‡
   ```java
   private static final String CACHE_INDEX_ID = "query-cache-index";
   ```

3. âœ… å®ç°ç´¢å¼•åŠ è½½/ä¿å­˜æ–¹æ³•
   - `loadCacheIndex()`
   - `saveCacheIndex()`

4. âœ… ä¿®æ”¹ç¼“å­˜åŠ è½½é€»è¾‘
   - ä»ç´¢å¼•æ–‡ä»¶è¯»å–ç¼“å­˜åˆ—è¡¨
   - æ ¹æ®ç´¢å¼•åŠ è½½æ¯ä¸ªç¼“å­˜

5. âœ… ç»´æŠ¤ç´¢å¼•ä¸€è‡´æ€§
   - ä¿å­˜æ—¶æ·»åŠ åˆ°ç´¢å¼•
   - åˆ é™¤æ—¶ä»ç´¢å¼•ç§»é™¤
   - å…³é—­æ—¶ä¿å­˜ç´¢å¼•

### è§£å†³çš„é—®é¢˜

- âœ… **ç¼–è¯‘é”™è¯¯** - ä¸å†ä½¿ç”¨ä¸å­˜åœ¨çš„æ–¹æ³•
- âœ… **æ€§èƒ½é—®é¢˜** - ä¸ä¼šåŠ è½½æ•´ä¸ªçŸ¥è¯†åº“
- âœ… **å‡†ç¡®æ€§** - åªåŠ è½½ç¼“å­˜ç›¸å…³æ–‡æ¡£
- âœ… **å¯ç»´æŠ¤æ€§** - è‡ªåŠ¨ç»´æŠ¤ç´¢å¼•

### æ€§èƒ½æå‡

- å¯åŠ¨é€Ÿåº¦ï¼š**æ•°åå€æå‡**
- å†…å­˜å ç”¨ï¼š**æ•°åå€é™ä½**
- å‡†ç¡®æ€§ï¼š**100%**ï¼ˆåªåŠ è½½ç¼“å­˜ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-12-27  
**çŠ¶æ€ï¼š** âœ… ç¼–è¯‘é€šè¿‡ï¼Œç”Ÿäº§å°±ç»ª  
**å…³é”®æ”¹è¿›ï¼š** ä½¿ç”¨ç´¢å¼•æ–‡ä»¶é¿å…éå†æ•´ä¸ªçŸ¥è¯†åº“

