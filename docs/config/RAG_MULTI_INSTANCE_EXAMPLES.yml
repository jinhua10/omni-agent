# RAG 多实例配置示例

## 示例 1: 主从架构（File + H2）

```yaml
server:
  port: 8080

omni-agent:
  rag:
    # 启用多实例模式
    multi-instance-enabled: true

    # 全局向量维度
    vector-dimension: 768

    # RAG 实例列表
    instances:
      # 主实例 - Lucene (高性能检索)
      - id: primary
        name: "主索引服务"
        type: file
        primary: true  # 标记为主实例
        file:
          index-path: ./data/rag-primary
          ram-buffer-size-mb: 64.0

      # 备份实例 - H2 (持久化存储)
      - id: backup
        name: "备份数据库"
        type: h2
        h2:
          database-path: ./data/rag-backup
          init-database: true
          enable-full-text: true
```

## 示例 2: 三层缓存架构

```yaml
omni-agent:
  rag:
    multi-instance-enabled: true
    vector-dimension: 768

    instances:
      # L1: Redis 热数据缓存
      - id: redis-cache
        name: "Redis 热缓存"
        type: redis
        primary: true
        redis:
          key-prefix: "rag:hot:"
          document-ttl: 1800  # 30分钟
          enable-text-index: true

      # L2: Lucene 温数据
      - id: lucene-warm
        name: "Lucene 温存储"
        type: file
        file:
          index-path: ./data/rag-warm
          ram-buffer-size-mb: 32.0

      # L3: H2 冷数据
      - id: h2-cold
        name: "H2 冷存储"
        type: h2
        h2:
          database-path: ./data/rag-cold
          init-database: true
```

**使用场景**：
- 最近访问的文档存在 Redis（快速）
- 近期文档存在 Lucene（较快）
- 历史文档存在 H2（持久化）

## 示例 3: 分域隔离

```yaml
omni-agent:
  rag:
    multi-instance-enabled: true
    vector-dimension: 768

    instances:
      # 用户文档域
      - id: user-docs
        name: "用户文档"
        type: file
        primary: true
        file:
          index-path: ./data/rag-users
          ram-buffer-size-mb: 32.0

      # 系统文档域
      - id: system-docs
        name: "系统文档"
        type: file
        file:
          index-path: ./data/rag-system
          ram-buffer-size-mb: 16.0

      # 公共知识库
      - id: knowledge-base
        name: "公共知识库"
        type: h2
        h2:
          database-path: ./data/rag-kb
          init-database: true
```

**使用场景**：
- 不同业务域的数据隔离
- 权限控制
- 数据安全

## 示例 4: 混合后端

```yaml
spring:
  data:
    mongodb:
      uri: mongodb://localhost:27017/omni-agent
    redis:
      host: localhost
      port: 6379

omni-agent:
  rag:
    multi-instance-enabled: true
    vector-dimension: 768

    instances:
      # 快速检索 - Lucene
      - id: search-index
        name: "搜索索引"
        type: file
        primary: true
        file:
          index-path: ./data/rag-search
          ram-buffer-size-mb: 64.0

      # 大规模存储 - MongoDB
      - id: document-store
        name: "文档存储"
        type: mongodb
        mongodb:
          collection-name: rag_documents
          enable-text-search: true

      # 实时缓存 - Redis
      - id: realtime-cache
        name: "实时缓存"
        type: redis
        redis:
          key-prefix: "rag:rt:"
          document-ttl: 600  # 10分钟

      # SQL 查询 - H2
      - id: analytics
        name: "分析数据库"
        type: h2
        h2:
          database-path: ./data/rag-analytics
          enable-full-text: true
```

## 代码示例

### 1. 双写策略

```java
@Service
public class DocumentIndexService {
    
    @Autowired
    private RagServiceRegistry registry;
    
    public void indexDocument(Document doc) {
        // 写入主实例
        RagService primary = registry.getServiceOrThrow("primary");
        primary.indexDocument(doc);
        
        // 异步写入备份
        CompletableFuture.runAsync(() -> {
            registry.getService("backup").ifPresent(backup -> {
                backup.indexDocument(doc);
            });
        });
    }
}
```

### 2. 读取降级

```java
@Service
public class SearchService {
    
    @Autowired
    private RagServiceRegistry registry;
    
    public List<Document> search(String query, int topK) {
        // 先从缓存读取
        Optional<RagService> cache = registry.getService("redis-cache");
        if (cache.isPresent()) {
            List<Document> results = cache.get().semanticSearch(query, topK);
            if (!results.isEmpty()) {
                return results;
            }
        }

        // 缓存未命中，从主存储读取
        RagService primary = registry.getServiceOrThrow("primary");
        return primary.semanticSearch(query, topK);
    }
}
```

### 3. 分域查询

```java
@Service
public class MultiDomainSearchService {
    
    @Autowired
    private RagServiceRegistry registry;
    
    public Map<String, List<Document>> searchAllDomains(String query) {
        Map<String, List<Document>> results = new HashMap<>();
        
        // 搜索所有实例
        registry.getAllServices().forEach((instanceId, service) -> {
            List<Document> docs = service.semanticSearch(query, 5);
            results.put(instanceId, docs);
        });
        
        return results;
    }

    public List<Document> searchByDomain(String domain, String query) {
        RagService service = registry.getServiceOrThrow(domain);
        return service.semanticSearch(query, 10);
    }
}
```

## 性能调优

### 1. 根据负载调整实例

**高读负载**：
```yaml
instances:
  - id: read-replica-1
    type: file
    primary: true
  - id: read-replica-2
    type: file
  - id: read-replica-3
    type: file
```

**高写负载**：
```yaml
instances:
  - id: write-primary
    type: h2  # 事务支持
    primary: true
  - id: write-backup
    type: mongodb
```

### 2. 内存优化

```yaml
instances:
  # 大内存实例
  - id: hot-index
    type: file
    file:
      ram-buffer-size-mb: 128.0  # 大缓冲区

  # 小内存实例
  - id: cold-index
    type: h2
    h2:
      database-path: ./data/rag-cold
```

## 监控和管理

### REST API 示例

```java
@RestController
@RequestMapping("/admin/rag")
public class RagAdminController {
    
    @Autowired
    private RagServiceRegistry registry;
    
    @GetMapping("/instances")
    public Map<String, Map<String, Object>> listInstances() {
        Map<String, Map<String, Object>> result = new HashMap<>();
        
        registry.getAllServices().forEach((id, service) -> {
            Map<String, Object> info = new HashMap<>();
            info.put("documentCount", service.getDocumentCount());
            info.put("type", service.getClass().getSimpleName());
            result.put(id, info);
        });
        
        return result;
    }

    @GetMapping("/instance/{id}/stats")
    public Map<String, Object> getInstanceStats(@PathVariable String id) {
        RagService service = registry.getServiceOrThrow(id);
        
        Map<String, Object> stats = new HashMap<>();
        stats.put("documentCount", service.getDocumentCount());
        stats.put("indexSize", "N/A");  // 根据实际实现
        
        return stats;
    }
}
```

---
**版本**: 2.0.0
**最后更新**: 2025-12-28

