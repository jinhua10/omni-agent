# ðŸ“‚ æ–‡ä»¶åä¼˜å…ˆå­˜å‚¨æž¶æž„ - æœ€ç»ˆå®žçŽ°

**å®žçŽ°æ—¶é—´**: 2025-12-19  
**åŽŸåˆ™**: ä½¿ç”¨åŽŸæ–‡æ¡£åç§°ç»„ç»‡ç›®å½•ï¼Œè€Œéž documentId  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ðŸŽ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### è®¾è®¡åŽŸåˆ™

**ä¸ä½¿ç”¨ documentId ä½œä¸ºç›®å½•å**ï¼Œè€Œæ˜¯**ä½¿ç”¨åŽŸæ–‡æ¡£åç§°**ï¼Œè¿™æ ·ï¼š

1. âœ… **ç›´è§‚å¯è¯»**: é€šè¿‡æ–‡ä»¶ç³»ç»Ÿç›´æŽ¥çœ‹åˆ°æ–‡æ¡£ç»“æž„
2. âœ… **æ˜“äºŽç®¡ç†**: æ— éœ€æ•°æ®åº“å³å¯è¯†åˆ«æ–‡æ¡£
3. âœ… **ä¾¿äºŽå¤‡ä»½**: æ–‡ä»¶åæœ‰æ„ä¹‰ï¼Œå¤‡ä»½åŽå¯è¯†åˆ«
4. âœ… **è·¨ç³»ç»Ÿå…¼å®¹**: æ–‡ä»¶åæœ¬èº«å°±æ˜¯å…ƒæ•°æ®

---

## ðŸ“‚ æœ€ç»ˆç›®å½•ç»“æž„

```
./data/
â”œâ”€â”€ documents/
â”‚   â”œâ”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
â”‚   â”‚   â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx
â”‚   â”œâ”€â”€ æŠ€æœ¯æ–‡æ¡£.pdf/
â”‚   â”‚   â””â”€â”€ æŠ€æœ¯æ–‡æ¡£.pdf
â”‚   â””â”€â”€ README.md/
â”‚       â””â”€â”€ README.md
â”‚
â”œâ”€â”€ chunks/
â”‚   â”œâ”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
â”‚   â”‚   â”œâ”€â”€ chunk_000.chunk
â”‚   â”‚   â”œâ”€â”€ chunk_001.chunk
â”‚   â”‚   â””â”€â”€ chunk_002.chunk
â”‚   â”œâ”€â”€ æŠ€æœ¯æ–‡æ¡£.pdf/
â”‚   â”‚   â”œâ”€â”€ chunk_000.chunk
â”‚   â”‚   â””â”€â”€ chunk_001.chunk
â”‚   â””â”€â”€ README.md/
â”‚       â””â”€â”€ chunk_000.chunk
â”‚
â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
â”‚   â”‚   â”œâ”€â”€ page_001_img.png
â”‚   â”‚   â”œâ”€â”€ page_002_img.png
â”‚   â”‚   â””â”€â”€ page_003_img.png
â”‚   â””â”€â”€ æŠ€æœ¯æ–‡æ¡£.pdf/
â”‚       â”œâ”€â”€ page_001_img.png
â”‚       â””â”€â”€ page_002_img.png
â”‚
â”œâ”€â”€ ppl/
â”‚   â”œâ”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
â”‚   â”‚   â””â”€â”€ ppl.data
â”‚   â””â”€â”€ æŠ€æœ¯æ–‡æ¡£.pdf/
â”‚       â””â”€â”€ ppl.data
â”‚
â””â”€â”€ optimization/
    â”œâ”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â”‚   â”œâ”€â”€ query_expansion.opt
    â”‚   â””â”€â”€ rerank.opt
    â””â”€â”€ æŠ€æœ¯æ–‡æ¡£.pdf/
        â””â”€â”€ hyde.opt
```

---

## ðŸ’¡ æ ¸å¿ƒå®žçŽ°

### 1. documentId åˆ° filename çš„æå–

```java
/**
 * ä»Ž documentId æå–åŽŸæ–‡ä»¶å
 * documentId æ ¼å¼: doc_timestamp_filename
 * ä¾‹å¦‚: doc_1766142807149_å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx
 */
private String extractFilenameFromDocumentId(String documentId) {
    // doc_1766142807149_å€¡å¯¼èŠ‚çº¦ç”¨æ°´.pptx -> å€¡å¯¼èŠ‚çº¦ç”¨æ°´.pptx
    if (documentId.startsWith("doc_")) {
        int secondUnderscore = documentId.indexOf('_', 4);
        if (secondUnderscore > 0 && secondUnderscore < documentId.length() - 1) {
            return documentId.substring(secondUnderscore + 1);
        }
    }
    return documentId; // é™çº§ï¼šç›´æŽ¥ä½¿ç”¨
}
```

### 2. ç»Ÿä¸€ä½¿ç”¨åŽŸæ–‡ä»¶åç»„ç»‡ç›®å½•

æ‰€æœ‰å­˜å‚¨æ–¹æ³•éƒ½ä½¿ç”¨ç›¸åŒçš„æ¨¡å¼ï¼š

```java
@Override
public String saveXXX(String documentId, XXX data) {
    // 1. æå–åŽŸæ–‡ä»¶å
    String filename = extractFilenameFromDocumentId(documentId);
    
    // 2. ä½¿ç”¨åŽŸæ–‡ä»¶ååˆ›å»ºå­ç›®å½•
    Path docDir = xxxPath.resolve(filename);
    Files.createDirectories(docDir);
    
    // 3. åœ¨å­ç›®å½•ä¸­ä¿å­˜æ–‡ä»¶ï¼ˆä½¿ç”¨æœ‰æ„ä¹‰çš„æ–‡ä»¶åï¼‰
    Path file = docDir.resolve("æœ‰æ„ä¹‰çš„æ–‡ä»¶å");
    // ...ä¿å­˜...
}
```

---

## ðŸ“Š å„æ¨¡å—æ–‡ä»¶å‘½åè§„èŒƒ

### Documentsï¼ˆåŽŸå§‹æ–‡æ¡£ï¼‰

```
documents/
â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx  # ä¿ç•™å®Œæ•´åŽŸæ–‡ä»¶å
```

### Chunksï¼ˆåˆ†å—ï¼‰

```
chunks/
â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â”œâ”€â”€ chunk_000.chunk  # ç¬¬1ä¸ªå—
    â”œâ”€â”€ chunk_001.chunk  # ç¬¬2ä¸ªå—
    â”œâ”€â”€ chunk_002.chunk  # ç¬¬3ä¸ªå—
    â””â”€â”€ ...
```

**å‘½åæ ¼å¼**: `chunk_{åºå·:3ä½æ•°å­—}.chunk`

### Imagesï¼ˆå›¾ç‰‡ï¼‰

```
images/
â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â”œâ”€â”€ page_001_img.png  # ç¬¬1é¡µçš„å›¾ç‰‡
    â”œâ”€â”€ page_002_img.png  # ç¬¬2é¡µçš„å›¾ç‰‡
    â”œâ”€â”€ page_003_img.png  # ç¬¬3é¡µçš„å›¾ç‰‡
    â””â”€â”€ ...
```

**å‘½åæ ¼å¼**: 
- æœ‰é¡µç : `page_{é¡µç :3ä½æ•°å­—}_img.{æ ¼å¼}`
- æ— é¡µç : `image_{idå‰8ä½}.{æ ¼å¼}`

### PPL Data

```
ppl/
â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â””â”€â”€ ppl.data  # PPLåˆ†æžæ•°æ®
```

**å‘½åæ ¼å¼**: `ppl.data`ï¼ˆå›ºå®šæ–‡ä»¶åï¼‰

### Optimization Data

```
optimization/
â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â”œâ”€â”€ query_expansion.opt  # æŸ¥è¯¢æ‰©å±•
    â”œâ”€â”€ rerank.opt           # é‡æŽ’åº
    â””â”€â”€ hyde.opt             # HyDE
```

**å‘½åæ ¼å¼**: `{ä¼˜åŒ–ç±»åž‹}.opt`

---

## ðŸ” å®žé™…ä¾‹å­

### ä¸Šä¼ æ–‡æ¡£

**ç”¨æˆ·æ“ä½œ**:
```bash
curl -X POST http://localhost:8080/api/documents/upload \
  -F "file=@å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx"
```

**ç”Ÿæˆçš„ documentId**:
```
doc_1766142807149_å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx
```

**æ–‡ä»¶ç³»ç»Ÿç»“æž„**:
```
data/
â”œâ”€â”€ documents/
â”‚   â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
â”‚       â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx
â”œâ”€â”€ chunks/
â”‚   â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
â”‚       â”œâ”€â”€ chunk_000.chunk
â”‚       â”œâ”€â”€ chunk_001.chunk
â”‚       â””â”€â”€ chunk_002.chunk
â””â”€â”€ images/
    â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
        â”œâ”€â”€ page_001_img.png
        â”œâ”€â”€ page_002_img.png
        â””â”€â”€ page_003_img.png
```

---

## âœ… ä¼˜åŠ¿åˆ†æž

### 1. ç›´è§‚æ€§

**æ—§æ–¹æ¡ˆï¼ˆä½¿ç”¨ documentIdï¼‰**:
```
chunks/
â””â”€â”€ doc_1766142807149_______PPT______/
    â”œâ”€â”€ chunk1.chunk
    â””â”€â”€ chunk2.chunk
```
âŒ æ— æ³•è¯†åˆ«è¿™æ˜¯ä»€ä¹ˆæ–‡æ¡£

**æ–°æ–¹æ¡ˆï¼ˆä½¿ç”¨åŽŸæ–‡ä»¶åï¼‰**:
```
chunks/
â””â”€â”€ å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/
    â”œâ”€â”€ chunk_000.chunk
    â””â”€â”€ chunk_001.chunk
```
âœ… ä¸€çœ¼å°±çŸ¥é“æ˜¯"å€¡å¯¼èŠ‚çº¦ç”¨æ°´"çš„PPT

### 2. å¯ç»´æŠ¤æ€§

```bash
# æŸ¥çœ‹æŸä¸ªæ–‡æ¡£çš„æ‰€æœ‰åˆ†å—
ls ./data/chunks/å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/

# è¾“å‡ºï¼š
chunk_000.chunk
chunk_001.chunk
chunk_002.chunk
```

âœ… ä¸éœ€è¦æŸ¥æ•°æ®åº“ï¼Œç›´æŽ¥å°±èƒ½æ‰¾åˆ°å¯¹åº”å…³ç³»

### 3. å¤‡ä»½å‹å¥½

```bash
# æ‰“åŒ…å¤‡ä»½
tar -czf backup.tar.gz ./data/chunks/å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/

# æ¢å¤åŽï¼Œç›´æŽ¥çœ‹åˆ°æ–‡ä»¶åå°±çŸ¥é“å†…å®¹
```

âœ… å¤‡ä»½æ–‡ä»¶åæœ‰æ„ä¹‰ï¼Œä¾¿äºŽå½’æ¡£å’Œæ¢å¤

### 4. è·¨ç³»ç»Ÿå…¼å®¹

å°† `./data` ç›®å½•å¤åˆ¶åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼š
```bash
cp -r ./data /backup/
```

âœ… æ— éœ€å¯¼å‡ºæ•°æ®åº“ï¼Œæ–‡ä»¶åæœ¬èº«å°±æ˜¯å…ƒæ•°æ®

---

## ðŸ”„ ä¸Žå…¶ä»–å­˜å‚¨åŽç«¯çš„å…¼å®¹

è™½ç„¶ç¤ºä¾‹æ˜¯ File å­˜å‚¨ï¼Œä½†åŒæ ·çš„åŽŸåˆ™é€‚ç”¨äºŽå…¶ä»–åŽç«¯ï¼š

### MinIO / S3

```
Bucket: omni-agent
â”œâ”€â”€ chunks/å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/chunk_000.chunk
â”œâ”€â”€ chunks/å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/chunk_001.chunk
â”œâ”€â”€ images/å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/page_001_img.png
â””â”€â”€ ...
```

### MongoDB GridFS

```javascript
{
  filename: "chunks/å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx/chunk_000.chunk",
  metadata: { documentName: "å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx", type: "chunk" }
}
```

### Redis

```
Key: chunks:å€¡å¯¼èŠ‚çº¦ç”¨æ°´PPTä½œå“ä¸‹è½½â€”â€”.pptx:chunk_000
Value: [chunk data]
```

---

## ðŸ“ æ–‡ä»¶åå†²çªå¤„ç†

### é—®é¢˜

å¦‚æžœä¸¤ä¸ªç”¨æˆ·ä¸Šä¼ åŒåæ–‡ä»¶ä¼šæ€Žæ ·ï¼Ÿ

```
ç”¨æˆ·Aä¸Šä¼ : report.pdf
ç”¨æˆ·Bä¸Šä¼ : report.pdf
```

### è§£å†³æ–¹æ¡ˆ

é€šè¿‡ **documentId** ä»ç„¶ä¿æŒå”¯ä¸€æ€§ï¼š

```
doc_1766142807149_report.pdf  # ç”¨æˆ·Açš„
doc_1766142807150_report.pdf  # ç”¨æˆ·Bçš„
```

æ–‡ä»¶ç³»ç»Ÿç»“æž„ï¼š
```
chunks/
â”œâ”€â”€ report.pdf/           # ç¬¬ä¸€ä¸ªä¸Šä¼ çš„
â”‚   â””â”€â”€ chunk_000.chunk
â””â”€â”€ report.pdf (1)/       # ç¬¬äºŒä¸ªä¸Šä¼ çš„ï¼ˆæ“ä½œç³»ç»Ÿè‡ªåŠ¨é‡å‘½åï¼‰
    â””â”€â”€ chunk_000.chunk
```

**æˆ–è€…**ï¼Œåœ¨åº”ç”¨å±‚å¤„ç†ï¼š
```java
String filename = extractFilenameFromDocumentId(documentId);
Path docDir = chunksPath.resolve(filename);

// å¦‚æžœç›®å½•å·²å­˜åœ¨ï¼Œæ·»åŠ æ—¶é—´æˆ³
if (Files.exists(docDir)) {
    filename = filename + "_" + System.currentTimeMillis();
    docDir = chunksPath.resolve(filename);
}
```

---

## ðŸŽ‰ æ€»ç»“

### æ ¸å¿ƒå®žçŽ°

1. âœ… **ä½¿ç”¨åŽŸæ–‡ä»¶å**: æ‰€æœ‰ç›®å½•ä½¿ç”¨åŽŸæ–‡æ¡£åç§°
2. âœ… **æœ‰æ„ä¹‰çš„æ–‡ä»¶å**: chunksã€images éƒ½ä½¿ç”¨æè¿°æ€§æ–‡ä»¶å
3. âœ… **ç»Ÿä¸€çš„æå–é€»è¾‘**: `extractFilenameFromDocumentId()` æ–¹æ³•
4. âœ… **å®Œæ•´çš„å®žçŽ°**: documentsã€chunksã€imagesã€pplã€optimization å…¨éƒ¨ç»Ÿä¸€

### è®¾è®¡ä¼˜åŠ¿

- ðŸ“‚ **ç›´è§‚**: æ–‡ä»¶ç³»ç»Ÿç»“æž„ä¸€ç›®äº†ç„¶
- ðŸ” **æ˜“æŸ¥æ‰¾**: æ— éœ€æ•°æ®åº“å³å¯å®šä½
- ðŸ’¾ **æ˜“å¤‡ä»½**: æ–‡ä»¶åæœ¬èº«å°±æ˜¯å…ƒæ•°æ®
- ðŸŒ **å›½é™…åŒ–**: æ”¯æŒä¸­æ–‡ã€æ—¥æ–‡ç­‰æ‰€æœ‰å­—ç¬¦
- ðŸ”Œ **å¯æ‰©å±•**: å…¶ä»–å­˜å‚¨åŽç«¯å¯ä½¿ç”¨ç›¸åŒåŽŸåˆ™

### ç”¨æˆ·ä»·å€¼

- ðŸ‘€ **å¯è§æ€§**: ç›´æŽ¥çœ‹åˆ°æ–‡æ¡£ç»„ç»‡
- ðŸ› ï¸ **å¯ç»´æŠ¤æ€§**: ä¾¿äºŽè°ƒè¯•å’Œé—®é¢˜æŽ’æŸ¥
- ðŸ“Š **å¯åˆ†æžæ€§**: å¯ä»¥ç›´æŽ¥ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·åˆ†æž
- ðŸ”„ **å¯è¿ç§»æ€§**: å¤åˆ¶ç›®å½•å³å¯è¿ç§»æ•°æ®

---

**å®Œæˆæ—¶é—´**: 2025-12-19  
**ç¼–è¯‘çŠ¶æ€**: âœ… BUILD SUCCESS  
**åŽŸåˆ™**: ä½¿ç”¨åŽŸæ–‡æ¡£åç§°ï¼Œè€Œéž documentId

ðŸŽ‰ **æ–‡ä»¶åä¼˜å…ˆå­˜å‚¨æž¶æž„å®žçŽ°å®Œæˆï¼çŽ°åœ¨æ‰€æœ‰å­˜å‚¨éƒ½ä½¿ç”¨åŽŸæ–‡æ¡£åç§°ç»„ç»‡ï¼Œç›´è§‚ä¸”æ˜“äºŽç®¡ç†ï¼** ðŸ“‚âœ¨

