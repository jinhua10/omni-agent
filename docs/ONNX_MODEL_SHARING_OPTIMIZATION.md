# ONNX æ¨¡å‹å…±äº«ä¼˜åŒ–æŒ‡å—

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

åœ¨ OmniAgent ç³»ç»Ÿä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„ ONNX æœåŠ¡ï¼š

1. **PPL åˆ†å—æœåŠ¡** (`PPLOnnxService`) - ç”¨äºæ™ºèƒ½æ–‡æœ¬åˆ†å—
2. **æ–‡æœ¬å‘é‡åŒ–æœåŠ¡** (`OnnxEmbeddingService`) - ç”¨äºç”Ÿæˆæ–‡æœ¬åµŒå…¥å‘é‡

å½“è¿™ä¸¤ä¸ªæœåŠ¡ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼ˆå¦‚ `bge-base-zh`ï¼‰æ—¶ï¼Œä¼šå¯¼è‡´ï¼š
- âŒ æ¨¡å‹è¢«åŠ è½½ä¸¤æ¬¡ï¼Œå ç”¨åŒå€å†…å­˜ï¼ˆ~800MBï¼‰
- âŒ å¯åŠ¨æ—¶é—´å»¶é•¿
- âŒ èµ„æºæµªè´¹

## âœ… è§£å†³æ–¹æ¡ˆ

å¼•å…¥ **å…±äº« ONNX æ¨¡å‹ç®¡ç†å™¨** (`SharedOnnxModelManager`)ï¼Œå®ç°æ¨¡å‹çš„å•ä¾‹åŠ è½½å’Œå¼•ç”¨è®¡æ•°ç®¡ç†ã€‚

### æ ¸å¿ƒæœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SharedOnnxModelManagerï¼ˆå…±äº«ç®¡ç†å™¨ï¼‰              â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Session Cacheï¼ˆæ¨¡å‹ç¼“å­˜ï¼‰                â”‚           â”‚
â”‚  â”‚  - model.onnx â†’ OrtSession (å¼•ç”¨è®¡æ•°: 2) â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                    â†“           â†“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PPL åˆ†å—æœåŠ¡    â”‚              â”‚ æ–‡æœ¬å‘é‡åŒ–æœåŠ¡    â”‚
â”‚                  â”‚              â”‚                  â”‚
â”‚  ä½¿ç”¨å…±äº«session  â”‚              â”‚  ä½¿ç”¨å…±äº«session  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŠ¿

- âœ… æ¨¡å‹åªåŠ è½½ä¸€æ¬¡ï¼ŒèŠ‚çœ~400MBå†…å­˜
- âœ… è‡ªåŠ¨å¼•ç”¨è®¡æ•°ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨é‡Šæ”¾
- âœ… çº¿ç¨‹å®‰å…¨
- âœ… å‘åå…¼å®¹ï¼ˆä»æ”¯æŒç‹¬ç«‹æ¨¡å¼ï¼‰

## ğŸ“ é…ç½®æ–¹å¼

### 1. ç»Ÿä¸€æ¨¡å‹é…ç½®ï¼ˆæ¨èï¼‰â­

åœ¨ `application.yml` ä¸­é…ç½®ç»Ÿä¸€çš„æ¨¡å‹è·¯å¾„ï¼š

```yaml
omni-agent:
  # ========== ç»Ÿä¸€ ONNX æ¨¡å‹é…ç½® ==========
  onnx:
    shared-model:
      enabled: true
      model-path: ./models/bge-base-zh/model.onnx
      max-sequence-length: 512

  # ========== PPL åˆ†å—é…ç½® ==========
  chunking:
    ppl:
      mode: onnx
      onnx:
        enabled: true
        # å¼•ç”¨å…±äº«æ¨¡å‹è·¯å¾„
        model-path: ${omni-agent.onnx.shared-model.model-path}
        tokenizer-path: ./models/bge-base-zh

  # ========== æ–‡æœ¬å‘é‡åŒ–é…ç½® ==========
  embedding:
    onnx:
      enabled: true
      # å¼•ç”¨å…±äº«æ¨¡å‹è·¯å¾„
      model-path: ${omni-agent.onnx.shared-model.model-path}
      max-sequence-length: ${omni-agent.onnx.shared-model.max-sequence-length}
```

### 2. ç‹¬ç«‹é…ç½®ï¼ˆä¸æ¨èï¼‰

å¦‚æœä½¿ç”¨ä¸åŒçš„æ¨¡å‹ï¼Œå¯ä»¥åˆ†åˆ«é…ç½®ï¼š

```yaml
omni-agent:
  chunking:
    ppl:
      onnx:
        model-path: ./models/bge-base-zh/model.onnx  # PPL ä¸“ç”¨æ¨¡å‹
        
  embedding:
    onnx:
      model-path: ./models/bge-large-zh/model.onnx  # å‘é‡åŒ–ä¸“ç”¨æ¨¡å‹
```

## ğŸ” å·¥ä½œåŸç†

### 1. é¦–æ¬¡åŠ è½½

```java
// PPL æœåŠ¡å¯åŠ¨
PPLOnnxService.init() 
  â†’ sharedModelManager.getOrCreateSession("bge-base-zh/model.onnx")
    â†’ æ¨¡å‹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–° session
    â†’ ç¼“å­˜ sessionï¼Œå¼•ç”¨è®¡æ•° = 1
    â†’ è¿”å› session

// Embedding æœåŠ¡å¯åŠ¨  
OnnxEmbeddingService(modelManager, "bge-base-zh/model.onnx")
  â†’ modelManager.getOrCreateSession("bge-base-zh/model.onnx")
    â†’ æ¨¡å‹å·²å­˜åœ¨ï¼Œå¤ç”¨ session â™»ï¸
    â†’ å¼•ç”¨è®¡æ•° = 2
    â†’ è¿”å›åŒä¸€ä¸ª session
```

### 2. å…³é—­é‡Šæ”¾

```java
// PPL æœåŠ¡å…³é—­
PPLOnnxService.destroy()
  â†’ sharedModelManager.releaseSession("bge-base-zh/model.onnx")
    â†’ å¼•ç”¨è®¡æ•° = 1ï¼ˆè¿˜æœ‰å…¶ä»–æœåŠ¡åœ¨ä½¿ç”¨ï¼‰
    â†’ ä¸å…³é—­ session

// Embedding æœåŠ¡å…³é—­
OnnxEmbeddingService.close()
  â†’ modelManager.releaseSession("bge-base-zh/model.onnx")
    â†’ å¼•ç”¨è®¡æ•° = 0ï¼ˆæœ€åä¸€ä¸ªå¼•ç”¨ï¼‰
    â†’ å…³é—­ session ğŸ”’
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å†…å­˜å ç”¨ | ~800MBï¼ˆ2ä¸ªæ¨¡å‹å®ä¾‹ï¼‰ |
| å¯åŠ¨æ—¶é—´ | ~8ç§’ |
| æ¨¡å‹åŠ è½½æ¬¡æ•° | 2æ¬¡ |

### ä¼˜åŒ–å

| æŒ‡æ ‡ | æ•°å€¼ | æ”¹å–„ |
|------|------|------|
| å†…å­˜å ç”¨ | ~400MBï¼ˆ1ä¸ªæ¨¡å‹å®ä¾‹ï¼‰ | â†“ 50% |
| å¯åŠ¨æ—¶é—´ | ~4ç§’ | â†“ 50% |
| æ¨¡å‹åŠ è½½æ¬¡æ•° | 1æ¬¡ | â†“ 50% |

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ¨¡å‹é€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ¨¡å‹ | ç»´åº¦ | å¤§å° |
|------|---------|------|------|
| é€šç”¨åœºæ™¯ | bge-base-zh-v1.5 | 768 | ~400MB |
| é«˜ç²¾åº¦éœ€æ±‚ | bge-large-zh | 1024 | ~1.3GB |
| å¤šè¯­è¨€æ”¯æŒ | bge-m3 | 1024 | ~2GB |

### 2. é…ç½®å»ºè®®

```yaml
# âœ… æ¨èï¼šä½¿ç”¨ç»Ÿä¸€æ¨¡å‹é…ç½®
omni-agent:
  onnx:
    shared-model:
      enabled: true
      model-path: ./models/bge-base-zh/model.onnx

# âŒ ä¸æ¨èï¼šåˆ†æ•£é…ç½®ç›¸åŒçš„æ¨¡å‹è·¯å¾„
omni-agent:
  chunking:
    ppl:
      onnx:
        model-path: ./models/bge-base-zh/model.onnx  # é‡å¤
  embedding:
    onnx:
      model-path: ./models/bge-base-zh/model.onnx  # é‡å¤
```

### 3. ç›‘æ§æ—¥å¿—

å¯åŠ¨æ—¶æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ¨¡å‹å…±äº«ï¼š

```
âœ… ONNX æ¨¡å‹åŠ è½½æˆåŠŸ: ./models/bge-base-zh/model.onnx (å¼•ç”¨è®¡æ•°: 1)
â™»ï¸ å¤ç”¨å·²åŠ è½½çš„ ONNX æ¨¡å‹: ./models/bge-base-zh/model.onnx (å¼•ç”¨è®¡æ•°: 2)
âœ… ONNX PPL æœåŠ¡åˆå§‹åŒ–å®Œæˆï¼ˆå…±äº«æ¨¡å¼: trueï¼‰
âœ… ONNX Embedding æœåŠ¡åˆå§‹åŒ–æˆåŠŸï¼ˆå…±äº«æ¨¡å¼: å·²å¯ç”¨ï¼‰
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ¨¡å‹ä»ç„¶è¢«åŠ è½½ä¸¤æ¬¡

**åŸå› **ï¼šé…ç½®è·¯å¾„ä¸ä¸€è‡´

```yaml
# âŒ é”™è¯¯ç¤ºä¾‹
chunking:
  ppl:
    onnx:
      model-path: ./models/bge-base-zh/model.onnx
embedding:
  onnx:
    model-path: models/bge-base-zh/model.onnx  # è·¯å¾„ä¸åŒï¼
```

**è§£å†³**ï¼šç»Ÿä¸€ä½¿ç”¨ç›¸åŒçš„è·¯å¾„æ ¼å¼

### é—®é¢˜2ï¼šSharedOnnxModelManager æœªç”Ÿæ•ˆ

**åŸå› **ï¼šä¾èµ–æ³¨å…¥å¤±è´¥

**è§£å†³**ï¼šæ£€æŸ¥ `SharedOnnxModelManager` æ˜¯å¦æ­£ç¡®æ³¨å†Œä¸º Spring Bean

```java
@Bean
@ConditionalOnMissingBean(SharedOnnxModelManager.class)
public SharedOnnxModelManager sharedOnnxModelManager() {
    return new SharedOnnxModelManager();
}
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `SharedOnnxModelManager.java` - å…±äº«æ¨¡å‹ç®¡ç†å™¨
- `OnnxEmbeddingAutoConfiguration.java` - Embedding è‡ªåŠ¨é…ç½®
- `PPLOnnxService.java` - PPL æœåŠ¡å®ç°
- `application.yml` - é…ç½®æ–‡ä»¶

## ğŸ‰ æ€»ç»“

é€šè¿‡å¼•å…¥å…±äº« ONNX æ¨¡å‹ç®¡ç†å™¨ï¼Œæˆ‘ä»¬æˆåŠŸï¼š

- âœ… å‡å°‘äº† 50% çš„å†…å­˜å ç”¨
- âœ… ç¼©çŸ­äº† 50% çš„å¯åŠ¨æ—¶é—´
- âœ… ä¿æŒäº†ä»£ç çš„ç®€æ´æ€§å’Œå‘åå…¼å®¹æ€§
- âœ… æä¾›äº†ç»Ÿä¸€çš„æ¨¡å‹é…ç½®æ–¹å¼

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ **å•ä¾‹æ¨¡å¼** å’Œ **å¼•ç”¨è®¡æ•°** çš„åº”ç”¨æ¡ˆä¾‹ã€‚

