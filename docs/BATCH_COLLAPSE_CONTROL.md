# 批次折叠控制功能 - 实现说明

## ✨ 新增功能

在文档提取过程中，用户可以自由地**收起或展开正在输出的批次内容**。

## 🎯 功能特性

### 1. 自由折叠控制
- ✅ 用户可以点击批次标题收起/展开单个批次
- ✅ 输出过程中也可以随时操作
- ✅ 收起批次不影响内容继续累加

### 2. 全部展开/收起按钮
- ✅ 一键展开所有批次
- ✅ 一键收起所有批次
- ✅ 按钮图标和文字动态显示当前状态

### 3. 默认行为
- ✅ 初始化时自动展开所有批次
- ✅ 用户可以在输出过程中随时调整

## 📊 UI 效果

### 标题栏（有批次时）
```
┌─────────────────────────────────────────────────────┐
│ 📄 提取结果  [合并批次] [展开] | [预览] [源码] ... │
└─────────────────────────────────────────────────────┘
```

**按钮说明**：
- **合并批次**：只在所有批次完成后显示
- **展开/收起**：动态切换，显示当前状态的反操作
  - 全部展开时显示 `[收起]`
  - 部分或全部收起时显示 `[展开]`

### 批次面板交互

**展开状态**：
```
┌─ 批次 1 [已完成 ✓] ▼ ───────────┐
│ ╔═══════════════════════════╗  │
│ ║ ## 📄 页面 1              ║  │
│ ║ 内容...                   ║  │
│ ╚═══════════════════════════╝  │
└────────────────────────────────┘

┌─ 批次 2 [处理中 ⟳] ▼ ───────────┐
│ ╔═══════════════════════════╗  │
│ ║ 正在输出内容...            ║  │
│ ╚═══════════════════════════╝  │
└────────────────────────────────┘
```

**收起状态**：
```
┌─ 批次 1 [已完成 ✓] ▶ ───────────┐
└────────────────────────────────┘

┌─ 批次 2 [处理中 ⟳] ▶ ───────────┐
└────────────────────────────────┘
```

## 🔧 技术实现

### 1. 状态管理

**新增状态**：
```javascript
const [expandedBatches, setExpandedBatches] = useState([])
// 存储展开的批次索引数组，例如：[0, 1, 2]
```

### 2. 初始化

**收到批次信息时**：
```javascript
else if (data.type === 'batchInfo') {
    const initialBatches = Array.from({ length: data.totalBatches }, ...);
    setBatches(initialBatches);
    
    // ⭐ 默认展开所有批次
    setExpandedBatches(initialBatches.map(b => b.index));
}
```

### 3. Collapse 组件配置

**可控模式**：
```javascript
<Collapse
    activeKey={expandedBatches}  // ⭐ 受控属性
    onChange={(keys) => {
        setExpandedBatches(keys)  // ⭐ 用户操作时更新
    }}
    items={...}
/>
```

**关键点**：
- `activeKey`：当前展开的批次索引数组
- `onChange`：用户点击时触发，接收新的展开数组

### 4. 全部展开/收起功能

```javascript
<Button
    icon={expandedBatches.length === batches.length 
        ? <ShrinkOutlined />   // 全部展开时显示收起图标
        : <ExpandOutlined />   // 否则显示展开图标
    }
    onClick={() => {
        if (expandedBatches.length === batches.length) {
            setExpandedBatches([])  // 全部收起
        } else {
            setExpandedBatches(batches.map(b => b.index))  // 全部展开
        }
    }}
>
    {expandedBatches.length === batches.length ? '收起' : '展开'}
</Button>
```

## 📋 使用场景

### 场景 1：输出过程中节省屏幕空间

**问题**：批次 1 输出完成，正在输出批次 2，但批次 1 占据太多空间

**操作**：
1. 点击批次 1 的标题，收起批次 1
2. 批次 2 继续输出（不受影响）
3. 屏幕空间更充裕

### 场景 2：只查看特定批次

**问题**：想只看批次 2 的内容，其他批次内容干扰视线

**操作**：
1. 点击"收起"按钮，全部收起
2. 点击批次 2 的标题，展开批次 2
3. 只看到批次 2 的内容

### 场景 3：大文档滚动查看

**问题**：文档有 10 个批次，内容太多，滚动不便

**操作**：
1. 查看批次 1-3，然后收起
2. 展开批次 4-6，查看
3. 收起批次 4-6，展开批次 7-10
4. 分段查看，减少滚动

### 场景 4：性能优化

**问题**：所有批次展开，Markdown 渲染占用资源

**操作**：
1. 收起不需要查看的批次
2. 减少同时渲染的 Markdown 内容
3. 提升页面性能

## 🎨 交互细节

### 1. 折叠动画
- ✅ Ant Design Collapse 自带展开/收起动画
- ✅ 平滑过渡，用户体验好

### 2. 状态持久化
- ❌ 刷新页面后重置为全部展开
- 💡 未来可以保存到 localStorage

### 3. 快捷键（可扩展）
- 💡 Ctrl + E：全部展开
- 💡 Ctrl + W：全部收起
- 💡 数字键 1-9：切换对应批次

## ✅ 改动文件清单

**文件**：`UI/src/components/document/TextExtractionConfig.jsx`

### 改动 1：导入图标 (Line ~30-46)
```javascript
import {
    // ...existing icons...
    ExpandOutlined,    // ⭐ 展开图标
    ShrinkOutlined,    // ⭐ 收起图标
} from '@ant-design/icons'
```

### 改动 2：添加状态 (Line ~113)
```javascript
const [expandedBatches, setExpandedBatches] = useState([])
```

### 改动 3：初始化展开状态 (Line ~337-350)
```javascript
else if (data.type === 'batchInfo') {
    // ...
    setExpandedBatches(initialBatches.map(b => b.index))
}
```

### 改动 4：可控 Collapse (Line ~708-725)
```javascript
<Collapse
    activeKey={expandedBatches}
    onChange={(keys) => setExpandedBatches(keys)}
    items={...}
/>
```

### 改动 5：全部展开/收起按钮 (Line ~640-666)
```javascript
<Button
    icon={expandedBatches.length === batches.length ? <ShrinkOutlined /> : <ExpandOutlined />}
    onClick={() => {...}}
>
    {expandedBatches.length === batches.length ? '收起' : '展开'}
</Button>
```

## 🧪 测试验证

### 测试 1：单个批次折叠
1. 开始提取，等待批次 1 开始输出
2. 点击批次 1 的标题
3. ✅ 验证：批次 1 收起，内容继续累加（查看控制台日志）
4. 再次点击批次 1 的标题
5. ✅ 验证：批次 1 展开，显示完整内容

### 测试 2：全部展开/收起
1. 等待多个批次输出
2. 点击"收起"按钮
3. ✅ 验证：所有批次收起
4. 点击"展开"按钮
5. ✅ 验证：所有批次展开

### 测试 3：输出过程中操作
1. 批次 1 输出中，收起批次 1
2. ✅ 验证：批次 1 内容继续累加（控制台显示）
3. 展开批次 1
4. ✅ 验证：显示最新的累加内容

### 测试 4：按钮状态
1. 所有批次展开时
   - ✅ 按钮显示"收起"图标和文字
2. 部分批次收起时
   - ✅ 按钮显示"展开"图标和文字
3. 所有批次收起时
   - ✅ 按钮显示"展开"图标和文字

## 💡 最佳实践

### 推荐用法
1. **大文档**：分批次查看，查看完一个批次就收起
2. **性能优化**：收起已查看的批次，减少渲染负担
3. **对比查看**：只展开需要对比的批次

### 不推荐
1. ❌ 频繁切换展开状态（可能影响体验）
2. ❌ 在批次输出过程中频繁操作（可能打断阅读）

## 🔮 未来增强

1. **记住展开状态**：localStorage 保存
2. **快捷键支持**：键盘操作
3. **智能展开**：
   - 正在处理的批次自动展开
   - 已完成的批次自动收起
4. **批次预览**：
   - 收起时显示前几行内容
   - 鼠标悬停显示更多信息

---

**版本**：v4.1.6 - 批次折叠控制版  
**新增时间**：2025-12-24  
**功能**：允许用户在输出过程中自由收起/展开批次

