# ğŸª å·¥ä½œæµå¸‚åœºå’ŒæŒä¹…åŒ–æ–¹æ¡ˆ

## ğŸ“‹ è®¾è®¡ç›®æ ‡

1. âœ… **å·¥ä½œæµå¸‚åœº** - ç±»ä¼¼ GitHub Marketplace
2. âœ… **ç”¨æˆ·åˆ›å»ºå’Œåˆ†äº«** - å‘å¸ƒã€ä¸‹è½½ã€æ”¶è—
3. âœ… **çµæ´»æŒä¹…åŒ–** - æ”¯æŒå¤šç§å­˜å‚¨åç«¯
4. âœ… **ç¤¾åŒºäº’åŠ¨** - è¯„åˆ†ã€è¯„è®ºã€ç‚¹èµ
5. âœ… **ç‰ˆæœ¬ç®¡ç†** - å·¥ä½œæµç‰ˆæœ¬æ§åˆ¶

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ä¸‰å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·¥ä½œæµå¸‚åœº UI  â”‚  å·¥ä½œæµç¼–è¾‘å™¨  â”‚  æˆ‘çš„å·¥ä½œæµ  â”‚  å¸‚åœºæµè§ˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡å±‚ â­                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WorkflowMarketService    â”‚  WorkflowStorageService         â”‚
â”‚  - å‘å¸ƒå·¥ä½œæµ              â”‚  - CRUD æ“ä½œ                     â”‚
â”‚  - æœç´¢/æµè§ˆ              â”‚  - ç‰ˆæœ¬ç®¡ç†                      â”‚
â”‚  - ä¸‹è½½/å®‰è£…              â”‚  - æŸ¥è¯¢                          â”‚
â”‚  - è¯„åˆ†/è¯„è®º              â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŒä¹…åŒ–å±‚ï¼ˆå¯æ’æ‹”ï¼‰â­                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WorkflowRepository (æ¥å£)                                   â”‚
â”‚      â†“              â†“              â†“              â†“          â”‚
â”‚  FileRepository  SQLiteRepo    MongoRepo      ESRepo        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ•°æ®æ¨¡å‹

### 1. MarketWorkflowï¼ˆå¸‚åœºå·¥ä½œæµï¼‰

```java
@Data
@Builder
public class MarketWorkflow {
    // åŸºæœ¬ä¿¡æ¯
    private String id;                    // å”¯ä¸€ID
    private String name;                  // å·¥ä½œæµåç§°
    private String version;               // ç‰ˆæœ¬å·
    private String description;           // æè¿°
    private String category;              // åˆ†ç±»
    private List<String> tags;            // æ ‡ç­¾
    
    // ä½œè€…ä¿¡æ¯
    private String authorId;              // ä½œè€…ID
    private String authorName;            // ä½œè€…åç§°
    
    // å·¥ä½œæµå®šä¹‰
    private Workflow workflowDefinition;  // å·¥ä½œæµå®šä¹‰
    
    // å¸‚åœºä¿¡æ¯
    private String status;                // draft/published/deprecated
    private boolean isPublic;             // æ˜¯å¦å…¬å¼€
    private String license;               // è®¸å¯è¯ï¼ˆMIT/Apache/GPLï¼‰
    
    // ç»Ÿè®¡ä¿¡æ¯
    private long downloadCount;           // ä¸‹è½½æ¬¡æ•°
    private long installCount;            // å®‰è£…æ¬¡æ•°
    private long favoriteCount;           // æ”¶è—æ¬¡æ•°
    private double rating;                // å¹³å‡è¯„åˆ†ï¼ˆ0-5ï¼‰
    private long ratingCount;             // è¯„åˆ†äººæ•°
    
    // æ—¶é—´ä¿¡æ¯
    private Long createdAt;
    private Long updatedAt;
    private Long publishedAt;
    
    // å…ƒæ•°æ®
    private Map<String, Object> metadata;
    
    // ä¾èµ–å…³ç³»
    private List<String> dependencies;    // ä¾èµ–çš„å…¶ä»–å·¥ä½œæµ
    private List<String> requiredAgents;  // éœ€è¦çš„ Agent
}
```

### 2. WorkflowRatingï¼ˆè¯„åˆ†ï¼‰

```java
@Data
@Builder
public class WorkflowRating {
    private String id;
    private String workflowId;
    private String userId;
    private String userName;
    private int rating;                   // 1-5 æ˜Ÿ
    private String comment;               // è¯„è®º
    private Long createdAt;
}
```

### 3. WorkflowInstallationï¼ˆå®‰è£…è®°å½•ï¼‰

```java
@Data
@Builder
public class WorkflowInstallation {
    private String id;
    private String workflowId;
    private String workflowVersion;
    private String userId;
    private Long installedAt;
    private boolean enabled;              // æ˜¯å¦å¯ç”¨
}
```

---

## ğŸ”Œ æŒä¹…åŒ–æ¥å£è®¾è®¡

### WorkflowRepository æ¥å£

```java
package top.yumbo.ai.omni.workflow.repository;

import java.util.List;
import java.util.Optional;

/**
 * å·¥ä½œæµå­˜å‚¨æ¥å£ï¼ˆå¯æ’æ‹”ï¼‰
 * 
 * æ”¯æŒå¤šç§å­˜å‚¨åç«¯ï¼šFile, SQLite, MongoDB, Elasticsearch
 */
public interface WorkflowRepository {
    
    // ========== åŸºç¡€ CRUD ==========
    
    /**
     * ä¿å­˜å·¥ä½œæµ
     */
    String save(MarketWorkflow workflow);
    
    /**
     * æ›´æ–°å·¥ä½œæµ
     */
    boolean update(MarketWorkflow workflow);
    
    /**
     * åˆ é™¤å·¥ä½œæµ
     */
    boolean delete(String workflowId);
    
    /**
     * æ ¹æ®IDæŸ¥è¯¢
     */
    Optional<MarketWorkflow> findById(String workflowId);
    
    /**
     * æ ¹æ®åç§°å’Œç‰ˆæœ¬æŸ¥è¯¢
     */
    Optional<MarketWorkflow> findByNameAndVersion(String name, String version);
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰ç‰ˆæœ¬
     */
    List<MarketWorkflow> findAllVersions(String name);
    
    /**
     * æŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬
     */
    Optional<MarketWorkflow> findLatestVersion(String name);
    
    // ========== å¸‚åœºæŸ¥è¯¢ ==========
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰å…¬å¼€å·¥ä½œæµ
     */
    List<MarketWorkflow> findPublic(int page, int size);
    
    /**
     * æŒ‰åˆ†ç±»æŸ¥è¯¢
     */
    List<MarketWorkflow> findByCategory(String category, int page, int size);
    
    /**
     * æŒ‰æ ‡ç­¾æŸ¥è¯¢
     */
    List<MarketWorkflow> findByTag(String tag, int page, int size);
    
    /**
     * æŒ‰ä½œè€…æŸ¥è¯¢
     */
    List<MarketWorkflow> findByAuthor(String authorId, int page, int size);
    
    /**
     * æœç´¢ï¼ˆåç§°ã€æè¿°ã€æ ‡ç­¾ï¼‰
     */
    List<MarketWorkflow> search(String keyword, int page, int size);
    
    /**
     * çƒ­é—¨å·¥ä½œæµï¼ˆæŒ‰ä¸‹è½½é‡æ’åºï¼‰
     */
    List<MarketWorkflow> findPopular(int limit);
    
    /**
     * æœ€æ–°å·¥ä½œæµ
     */
    List<MarketWorkflow> findRecent(int limit);
    
    /**
     * é«˜è¯„åˆ†å·¥ä½œæµ
     */
    List<MarketWorkflow> findTopRated(int limit);
    
    // ========== ç»Ÿè®¡æ›´æ–° ==========
    
    /**
     * å¢åŠ ä¸‹è½½æ¬¡æ•°
     */
    void incrementDownloadCount(String workflowId);
    
    /**
     * å¢åŠ å®‰è£…æ¬¡æ•°
     */
    void incrementInstallCount(String workflowId);
    
    /**
     * å¢åŠ æ”¶è—æ¬¡æ•°
     */
    void incrementFavoriteCount(String workflowId);
    
    /**
     * æ›´æ–°è¯„åˆ†
     */
    void updateRating(String workflowId, double rating, long ratingCount);
    
    // ========== è¯„åˆ†å’Œè¯„è®º ==========
    
    /**
     * ä¿å­˜è¯„åˆ†
     */
    String saveRating(WorkflowRating rating);
    
    /**
     * æŸ¥è¯¢å·¥ä½œæµçš„è¯„åˆ†
     */
    List<WorkflowRating> findRatings(String workflowId, int page, int size);
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·çš„è¯„åˆ†
     */
    Optional<WorkflowRating> findUserRating(String workflowId, String userId);
    
    // ========== å®‰è£…è®°å½• ==========
    
    /**
     * ä¿å­˜å®‰è£…è®°å½•
     */
    String saveInstallation(WorkflowInstallation installation);
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·å·²å®‰è£…çš„å·¥ä½œæµ
     */
    List<WorkflowInstallation> findUserInstallations(String userId);
    
    /**
     * æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
     */
    boolean isInstalled(String workflowId, String userId);
}
```

---

## ğŸ”§ å…·ä½“å®ç°

### 1. SQLite å®ç°

```java
package top.yumbo.ai.omni.workflow.repository.impl;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;

@Slf4j
public class SQLiteWorkflowRepository implements WorkflowRepository {
    
    private final JdbcTemplate jdbcTemplate;
    private final ObjectMapper objectMapper;
    
    // è¡¨ç»“æ„
    private static final String CREATE_TABLES = """
        CREATE TABLE IF NOT EXISTS market_workflows (
            id TEXT PRIMARY KEY,
            name TEXT NOT NULL,
            version TEXT NOT NULL,
            description TEXT,
            category TEXT,
            tags TEXT,
            author_id TEXT,
            author_name TEXT,
            workflow_definition TEXT,
            status TEXT,
            is_public INTEGER,
            license TEXT,
            download_count INTEGER DEFAULT 0,
            install_count INTEGER DEFAULT 0,
            favorite_count INTEGER DEFAULT 0,
            rating REAL DEFAULT 0,
            rating_count INTEGER DEFAULT 0,
            created_at INTEGER,
            updated_at INTEGER,
            published_at INTEGER,
            metadata TEXT,
            UNIQUE(name, version)
        );
        
        CREATE INDEX IF NOT EXISTS idx_category ON market_workflows(category);
        CREATE INDEX IF NOT EXISTS idx_author ON market_workflows(author_id);
        CREATE INDEX IF NOT EXISTS idx_status ON market_workflows(status);
        CREATE INDEX IF NOT EXISTS idx_public ON market_workflows(is_public);
        
        CREATE TABLE IF NOT EXISTS workflow_ratings (
            id TEXT PRIMARY KEY,
            workflow_id TEXT NOT NULL,
            user_id TEXT NOT NULL,
            user_name TEXT,
            rating INTEGER,
            comment TEXT,
            created_at INTEGER,
            FOREIGN KEY(workflow_id) REFERENCES market_workflows(id),
            UNIQUE(workflow_id, user_id)
        );
        
        CREATE TABLE IF NOT EXISTS workflow_installations (
            id TEXT PRIMARY KEY,
            workflow_id TEXT NOT NULL,
            workflow_version TEXT,
            user_id TEXT NOT NULL,
            installed_at INTEGER,
            enabled INTEGER,
            FOREIGN KEY(workflow_id) REFERENCES market_workflows(id),
            UNIQUE(workflow_id, user_id)
        );
    """;
    
    public SQLiteWorkflowRepository(JdbcTemplate jdbcTemplate, ObjectMapper objectMapper) {
        this.jdbcTemplate = jdbcTemplate;
        this.objectMapper = objectMapper;
        initDatabase();
    }
    
    private void initDatabase() {
        jdbcTemplate.execute(CREATE_TABLES);
        log.info("âœ… SQLite å·¥ä½œæµè¡¨åˆå§‹åŒ–å®Œæˆ");
    }
    
    @Override
    public String save(MarketWorkflow workflow) {
        String sql = """
            INSERT INTO market_workflows (
                id, name, version, description, category, tags,
                author_id, author_name, workflow_definition, status,
                is_public, license, download_count, install_count,
                favorite_count, rating, rating_count, created_at,
                updated_at, published_at, metadata
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        """;
        
        try {
            jdbcTemplate.update(sql,
                workflow.getId(),
                workflow.getName(),
                workflow.getVersion(),
                workflow.getDescription(),
                workflow.getCategory(),
                toJson(workflow.getTags()),
                workflow.getAuthorId(),
                workflow.getAuthorName(),
                toJson(workflow.getWorkflowDefinition()),
                workflow.getStatus(),
                workflow.isPublic() ? 1 : 0,
                workflow.getLicense(),
                workflow.getDownloadCount(),
                workflow.getInstallCount(),
                workflow.getFavoriteCount(),
                workflow.getRating(),
                workflow.getRatingCount(),
                workflow.getCreatedAt(),
                workflow.getUpdatedAt(),
                workflow.getPublishedAt(),
                toJson(workflow.getMetadata())
            );
            
            return workflow.getId();
        } catch (Exception e) {
            log.error("ä¿å­˜å·¥ä½œæµå¤±è´¥", e);
            return null;
        }
    }
    
    @Override
    public List<MarketWorkflow> findPublic(int page, int size) {
        String sql = """
            SELECT * FROM market_workflows 
            WHERE is_public = 1 AND status = 'published'
            ORDER BY created_at DESC
            LIMIT ? OFFSET ?
        """;
        
        return jdbcTemplate.query(sql, workflowRowMapper(), size, page * size);
    }
    
    @Override
    public List<MarketWorkflow> search(String keyword, int page, int size) {
        String sql = """
            SELECT * FROM market_workflows 
            WHERE is_public = 1 
            AND status = 'published'
            AND (name LIKE ? OR description LIKE ? OR tags LIKE ?)
            ORDER BY download_count DESC
            LIMIT ? OFFSET ?
        """;
        
        String pattern = "%" + keyword + "%";
        return jdbcTemplate.query(sql, workflowRowMapper(), 
                pattern, pattern, pattern, size, page * size);
    }
    
    @Override
    public List<MarketWorkflow> findPopular(int limit) {
        String sql = """
            SELECT * FROM market_workflows 
            WHERE is_public = 1 AND status = 'published'
            ORDER BY download_count DESC, rating DESC
            LIMIT ?
        """;
        
        return jdbcTemplate.query(sql, workflowRowMapper(), limit);
    }
    
    private RowMapper<MarketWorkflow> workflowRowMapper() {
        return (rs, rowNum) -> {
            try {
                return MarketWorkflow.builder()
                    .id(rs.getString("id"))
                    .name(rs.getString("name"))
                    .version(rs.getString("version"))
                    .description(rs.getString("description"))
                    .category(rs.getString("category"))
                    .tags(fromJson(rs.getString("tags"), List.class))
                    .authorId(rs.getString("author_id"))
                    .authorName(rs.getString("author_name"))
                    .workflowDefinition(fromJson(rs.getString("workflow_definition"), Workflow.class))
                    .status(rs.getString("status"))
                    .isPublic(rs.getInt("is_public") == 1)
                    .license(rs.getString("license"))
                    .downloadCount(rs.getLong("download_count"))
                    .installCount(rs.getLong("install_count"))
                    .favoriteCount(rs.getLong("favorite_count"))
                    .rating(rs.getDouble("rating"))
                    .ratingCount(rs.getLong("rating_count"))
                    .createdAt(rs.getLong("created_at"))
                    .updatedAt(rs.getLong("updated_at"))
                    .publishedAt(rs.getLong("published_at"))
                    .metadata(fromJson(rs.getString("metadata"), Map.class))
                    .build();
            } catch (Exception e) {
                throw new RuntimeException("è§£æå·¥ä½œæµå¤±è´¥", e);
            }
        };
    }
    
    private String toJson(Object obj) {
        try {
            return objectMapper.writeValueAsString(obj);
        } catch (Exception e) {
            return null;
        }
    }
    
    private <T> T fromJson(String json, Class<T> type) {
        try {
            return objectMapper.readValue(json, type);
        } catch (Exception e) {
            return null;
        }
    }
}
```

### 2. MongoDB å®ç°

```java
package top.yumbo.ai.omni.workflow.repository.impl;

import lombok.extern.slf4j.Slf4j;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.data.mongodb.core.query.Update;

@Slf4j
public class MongoWorkflowRepository implements WorkflowRepository {
    
    private final MongoTemplate mongoTemplate;
    private static final String COLLECTION = "market_workflows";
    
    public MongoWorkflowRepository(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
    }
    
    @Override
    public String save(MarketWorkflow workflow) {
        mongoTemplate.save(workflow, COLLECTION);
        return workflow.getId();
    }
    
    @Override
    public Optional<MarketWorkflow> findById(String workflowId) {
        MarketWorkflow workflow = mongoTemplate.findById(workflowId, MarketWorkflow.class, COLLECTION);
        return Optional.ofNullable(workflow);
    }
    
    @Override
    public List<MarketWorkflow> search(String keyword, int page, int size) {
        Query query = new Query();
        query.addCriteria(
            Criteria.where("isPublic").is(true)
                .and("status").is("published")
                .orOperator(
                    Criteria.where("name").regex(keyword, "i"),
                    Criteria.where("description").regex(keyword, "i"),
                    Criteria.where("tags").in(keyword)
                )
        );
        query.skip(page * size).limit(size);
        
        return mongoTemplate.find(query, MarketWorkflow.class, COLLECTION);
    }
    
    @Override
    public List<MarketWorkflow> findPopular(int limit) {
        Query query = new Query();
        query.addCriteria(
            Criteria.where("isPublic").is(true)
                .and("status").is("published")
        );
        query.limit(limit);
        query.with(Sort.by(Sort.Direction.DESC, "downloadCount", "rating"));
        
        return mongoTemplate.find(query, MarketWorkflow.class, COLLECTION);
    }
    
    @Override
    public void incrementDownloadCount(String workflowId) {
        Query query = new Query(Criteria.where("id").is(workflowId));
        Update update = new Update().inc("downloadCount", 1);
        mongoTemplate.updateFirst(query, update, COLLECTION);
    }
}
```

### 3. Elasticsearch å®ç°

```java
package top.yumbo.ai.omni.workflow.repository.impl;

import co.elastic.clients.elasticsearch.ElasticsearchClient;
import co.elastic.clients.elasticsearch.core.*;
import co.elastic.clients.elasticsearch.core.search.Hit;

@Slf4j
public class ElasticsearchWorkflowRepository implements WorkflowRepository {
    
    private final ElasticsearchClient esClient;
    private static final String INDEX = "market-workflows";
    
    @Override
    public String save(MarketWorkflow workflow) {
        try {
            IndexResponse response = esClient.index(i -> i
                .index(INDEX)
                .id(workflow.getId())
                .document(workflow)
            );
            return response.id();
        } catch (Exception e) {
            log.error("ä¿å­˜åˆ° ES å¤±è´¥", e);
            return null;
        }
    }
    
    @Override
    public List<MarketWorkflow> search(String keyword, int page, int size) {
        try {
            SearchResponse<MarketWorkflow> response = esClient.search(s -> s
                .index(INDEX)
                .query(q -> q
                    .bool(b -> b
                        .must(m -> m.term(t -> t.field("isPublic").value(true)))
                        .must(m -> m.term(t -> t.field("status").value("published")))
                        .should(sh -> sh
                            .multiMatch(mm -> mm
                                .query(keyword)
                                .fields("name^3", "description^2", "tags")
                            )
                        )
                    )
                )
                .from(page * size)
                .size(size)
                .sort(so -> so.field(f -> f.field("downloadCount").order(SortOrder.Desc)))
                , MarketWorkflow.class
            );
            
            return response.hits().hits().stream()
                .map(Hit::source)
                .collect(Collectors.toList());
                
        } catch (Exception e) {
            log.error("ES æœç´¢å¤±è´¥", e);
            return Collections.emptyList();
        }
    }
}
```

---

## ğŸ¨ WorkflowMarketService

```java
package top.yumbo.ai.omni.workflow.market;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Slf4j
@Service
public class WorkflowMarketService {
    
    @Autowired
    private WorkflowRepository workflowRepository;
    
    @Autowired
    private WorkflowRegistry workflowRegistry;
    
    /**
     * å‘å¸ƒå·¥ä½œæµåˆ°å¸‚åœº
     */
    public String publishWorkflow(Workflow workflow, String authorId, String authorName) {
        MarketWorkflow marketWorkflow = MarketWorkflow.builder()
            .id(UUID.randomUUID().toString())
            .name(workflow.getName())
            .version(workflow.getVersion())
            .description(workflow.getDescription())
            .authorId(authorId)
            .authorName(authorName)
            .workflowDefinition(workflow)
            .status("published")
            .isPublic(true)
            .license("MIT")
            .createdAt(System.currentTimeMillis())
            .updatedAt(System.currentTimeMillis())
            .publishedAt(System.currentTimeMillis())
            .build();
        
        String id = workflowRepository.save(marketWorkflow);
        log.info("âœ… å·¥ä½œæµå·²å‘å¸ƒåˆ°å¸‚åœº: name={}, id={}", workflow.getName(), id);
        return id;
    }
    
    /**
     * ä»å¸‚åœºä¸‹è½½å·¥ä½œæµ
     */
    public Workflow downloadWorkflow(String workflowId, String userId) {
        Optional<MarketWorkflow> opt = workflowRepository.findById(workflowId);
        if (opt.isEmpty()) {
            throw new RuntimeException("å·¥ä½œæµä¸å­˜åœ¨");
        }
        
        MarketWorkflow marketWorkflow = opt.get();
        
        // å¢åŠ ä¸‹è½½æ¬¡æ•°
        workflowRepository.incrementDownloadCount(workflowId);
        
        log.info("â¬‡ï¸ ç”¨æˆ·ä¸‹è½½å·¥ä½œæµ: user={}, workflow={}", userId, marketWorkflow.getName());
        
        return marketWorkflow.getWorkflowDefinition();
    }
    
    /**
     * å®‰è£…å·¥ä½œæµåˆ°æœ¬åœ°
     */
    public boolean installWorkflow(String workflowId, String userId) {
        Workflow workflow = downloadWorkflow(workflowId, userId);
        
        // æ³¨å†Œåˆ°æœ¬åœ°
        workflowRegistry.register(workflow);
        
        // è®°å½•å®‰è£…
        WorkflowInstallation installation = WorkflowInstallation.builder()
            .id(UUID.randomUUID().toString())
            .workflowId(workflowId)
            .workflowVersion(workflow.getVersion())
            .userId(userId)
            .installedAt(System.currentTimeMillis())
            .enabled(true)
            .build();
        
        workflowRepository.saveInstallation(installation);
        workflowRepository.incrementInstallCount(workflowId);
        
        log.info("âœ… å·¥ä½œæµå·²å®‰è£…: user={}, workflow={}", userId, workflow.getName());
        return true;
    }
    
    /**
     * æœç´¢å·¥ä½œæµ
     */
    public List<MarketWorkflow> searchWorkflows(String keyword, int page, int size) {
        return workflowRepository.search(keyword, page, size);
    }
    
    /**
     * è·å–çƒ­é—¨å·¥ä½œæµ
     */
    public List<MarketWorkflow> getPopularWorkflows(int limit) {
        return workflowRepository.findPopular(limit);
    }
    
    /**
     * è¯„åˆ†
     */
    public boolean rateWorkflow(String workflowId, String userId, String userName, 
                                int rating, String comment) {
        WorkflowRating workflowRating = WorkflowRating.builder()
            .id(UUID.randomUUID().toString())
            .workflowId(workflowId)
            .userId(userId)
            .userName(userName)
            .rating(rating)
            .comment(comment)
            .createdAt(System.currentTimeMillis())
            .build();
        
        workflowRepository.saveRating(workflowRating);
        
        // é‡æ–°è®¡ç®—å¹³å‡åˆ†
        List<WorkflowRating> allRatings = workflowRepository.findRatings(workflowId, 0, Integer.MAX_VALUE);
        double avgRating = allRatings.stream()
            .mapToInt(WorkflowRating::getRating)
            .average()
            .orElse(0.0);
        
        workflowRepository.updateRating(workflowId, avgRating, allRatings.size());
        
        log.info("â­ ç”¨æˆ·è¯„åˆ†: user={}, workflow={}, rating={}", 
                 userId, workflowId, rating);
        return true;
    }
}
```

---

## ğŸ“Š é…ç½®ç®¡ç†

```yaml
# application.yml
omni-agent:
  workflow:
    # å­˜å‚¨ç±»å‹: file | sqlite | mongodb | elasticsearch
    storage-type: sqlite
    
    # SQLite é…ç½®
    sqlite:
      db-path: ./data/workflows/workflows.db
    
    # MongoDB é…ç½®
    mongodb:
      uri: mongodb://localhost:27017
      database: omniagent
      collection: workflows
    
    # Elasticsearch é…ç½®
    elasticsearch:
      uris: http://localhost:9200
      index: market-workflows
    
    # å¸‚åœºé…ç½®
    market:
      enabled: true
      page-size: 20
      max-file-size: 10485760  # 10MB
```

---

## ğŸ¨ REST API

```java
@RestController
@RequestMapping("/api/workflows/market")
public class WorkflowMarketController {
    
    @Autowired
    private WorkflowMarketService marketService;
    
    /**
     * å‘å¸ƒå·¥ä½œæµ
     */
    @PostMapping("/publish")
    public Map<String, Object> publishWorkflow(
            @RequestBody Workflow workflow,
            @RequestHeader("X-User-Id") String userId,
            @RequestHeader("X-User-Name") String userName) {
        
        String id = marketService.publishWorkflow(workflow, userId, userName);
        return Map.of("success", true, "id", id);
    }
    
    /**
     * æœç´¢å·¥ä½œæµ
     */
    @GetMapping("/search")
    public List<MarketWorkflow> search(
            @RequestParam String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        return marketService.searchWorkflows(keyword, page, size);
    }
    
    /**
     * çƒ­é—¨å·¥ä½œæµ
     */
    @GetMapping("/popular")
    public List<MarketWorkflow> popular(@RequestParam(defaultValue = "10") int limit) {
        return marketService.getPopularWorkflows(limit);
    }
    
    /**
     * ä¸‹è½½å·¥ä½œæµ
     */
    @GetMapping("/{workflowId}/download")
    public Workflow download(
            @PathVariable String workflowId,
            @RequestHeader("X-User-Id") String userId) {
        
        return marketService.downloadWorkflow(workflowId, userId);
    }
    
    /**
     * å®‰è£…å·¥ä½œæµ
     */
    @PostMapping("/{workflowId}/install")
    public Map<String, Object> install(
            @PathVariable String workflowId,
            @RequestHeader("X-User-Id") String userId) {
        
        boolean success = marketService.installWorkflow(workflowId, userId);
        return Map.of("success", success);
    }
    
    /**
     * è¯„åˆ†
     */
    @PostMapping("/{workflowId}/rate")
    public Map<String, Object> rate(
            @PathVariable String workflowId,
            @RequestHeader("X-User-Id") String userId,
            @RequestHeader("X-User-Name") String userName,
            @RequestBody RatingRequest request) {
        
        boolean success = marketService.rateWorkflow(
            workflowId, userId, userName, request.getRating(), request.getComment()
        );
        return Map.of("success", success);
    }
}
```

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

1. âœ… **å·¥ä½œæµå¸‚åœº** - å‘å¸ƒã€æœç´¢ã€ä¸‹è½½ã€å®‰è£…
2. âœ… **çµæ´»æŒä¹…åŒ–** - æ”¯æŒ SQLite/MongoDB/ES/File
3. âœ… **ç¤¾åŒºäº’åŠ¨** - è¯„åˆ†ã€è¯„è®ºã€ç»Ÿè®¡
4. âœ… **ç‰ˆæœ¬ç®¡ç†** - å¤šç‰ˆæœ¬æ”¯æŒ
5. âœ… **å¯æ’æ‹”è®¾è®¡** - æ˜“äºæ‰©å±•æ–°çš„å­˜å‚¨åç«¯

### å®æ–½è·¯å¾„

1. **Phase 1** âœ… - åŸºç¡€å·¥ä½œæµå¼•æ“ï¼ˆå·²å®Œæˆï¼‰
2. **Phase 2** - å·¥ä½œæµå¸‚åœºå’ŒæŒä¹…åŒ–ï¼ˆå½“å‰ï¼‰
   - æŒä¹…åŒ–æ¥å£è®¾è®¡
   - SQLite å®ç°
   - å¸‚åœºæœåŠ¡
   - REST API

3. **Phase 3** - å‰ç«¯UI
   - å¸‚åœºæµè§ˆé¡µé¢
   - å·¥ä½œæµè¯¦æƒ…é¡µé¢
   - å®‰è£…ç®¡ç†é¡µé¢

**å·¥ä½œæµç³»ç»Ÿå°†å…·å¤‡å®Œæ•´çš„ç”Ÿæ€èƒ½åŠ›ï¼** ğŸš€

