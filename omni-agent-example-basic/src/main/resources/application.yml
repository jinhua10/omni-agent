server:
  port: 8080

spring:
  application:
    name: omni-agent-example-basic

  # 文件上传配置 (File Upload Configuration)
  servlet:
    multipart:
      enabled: true
      max-file-size: 100MB      # 单个文件最大100MB
      max-request-size: 100MB   # 整个请求最大100MB
      file-size-threshold: 2KB  # 文件写入磁盘的阈值
# ========== PPL ONNX 配置 ⭐ ==========
ppl:
  onnx:
    # 启用 ONNX PPL 服务
    enabled: true

    # ONNX 模型路径（BGE-base-zh）
    model-path: ./models/bge-base-zh/model.onnx

    # Tokenizer 路径
    tokenizer-path: ./models/bge-base-zh

    # 缓存配置
    use-cache: true          # 启用缓存
    cache-size: 1000         # 缓存大小
    cache-ttl: 3600          # 缓存过期时间（秒）
# ========== OmniAgent 四维可插拔配置 ==========
# 1. 持久化配置 (Persistence)
# 支持多种后端：file, sqlite, h2, memory, redis, mongodb, elasticsearch
omni-agent:
  persistence:
    # ========== 当前使用的后端类型 ==========
    type: sqlite

    # ========== File 配置（最简单、零依赖）==========
    # type: file
    file:
      base-path: ./data/persistence     # 持久化数据根目录
      # File持久化将数据以JSON格式存储在文件系统中
      # 优点：零依赖、最简单、适合小规模数据
      # 缺点：性能较低、不支持复杂查询

    # ========== SQLite 配置（推荐：轻量级、无需额外服务）==========
    sqlite:
      db-path: ./data/omni-agent.db     # 数据库文件路径
      auto-create-tables: true          # 自动创建表
      show-sql: false                   # 是否显示SQL语句
      connection-timeout: 30000         # 连接超时（毫秒）

    # ========== H2 配置（开发/测试环境）==========
    # type: h2
    h2:
      db-path: ./data/omni-agent-h2     # H2数据库文件路径（无需.mv.db后缀）
      mode: file                        # file: 文件模式, memory: 内存模式
      auto-create-tables: true
      show-sql: false
      # 内存模式示例：
      # mode: memory
      # db-name: testdb

    # ========== Memory 配置（快速测试）==========
    # type: memory
    memory:
      # 内存持久化无需额外配置，数据仅存在于内存中
      # 优点：速度最快
      # 缺点：重启后数据丢失
      initial-capacity: 1000            # 初始容量

    # ========== Redis 配置（高性能、分布式）==========
    # type: redis
    redis:
      host: localhost                   # Redis服务器地址
      port: 6379                        # Redis端口
      password:                         # Redis密码（如果有）
      database: 0                       # 使用的数据库编号
      timeout: 3000                     # 超时时间（毫秒）
      # 连接池配置
      pool:
        max-active: 8                   # 最大连接数
        max-idle: 8                     # 最大空闲连接
        min-idle: 0                     # 最小空闲连接
        max-wait: -1                    # 最大等待时间（-1表示无限）

    # ========== MongoDB 配置（文档数据库）==========
    # type: mongodb
    mongodb:
      uri: mongodb://localhost:27017    # MongoDB连接URI
      database: omni-agent              # 数据库名称
      # 或使用详细配置：
      # host: localhost
      # port: 27017
      # username: admin
      # password: password
      # database: omni-agent
      # auth-database: admin

    # ========== Elasticsearch 配置（全文搜索、大规模）==========
    # type: elasticsearch
    elasticsearch:
      hosts:
        - localhost:9200                # ES节点地址（支持多个）
      username:                         # 用户名（如果启用安全）
      password:                         # 密码
      connection-timeout: 5000          # 连接超时
      socket-timeout: 60000             # Socket超时
      index-prefix: omni-agent          # 索引前缀

  # 2. 文档存储配置 (Document Storage)
  # 支持多种后端：file, minio, s3, redis, mongodb, elasticsearch
  document-storage:
    # ========== 当前使用的后端类型 ==========
    type: file

    # ========== File 配置（推荐：简单、直接）==========
    file:
      base-path: ./data/documents       # 文档存储根目录
      chunk-path: ./data/chunks         # 分块存储目录
      image-path: ./data/images         # 图片存储目录
      ppl-path: ./data/ppl              # PPL数据存储目录
      max-file-size: 104857600          # 最大文件大小（100MB）

    # ========== MinIO 配置（对象存储、推荐生产环境）==========
    # type: minio
    minio:
      endpoint: http://localhost:9000   # MinIO服务地址
      access-key: minioadmin            # 访问密钥
      secret-key: minioadmin            # 密钥
      bucket: omni-agent                # 存储桶名称
      auto-create-bucket: true          # 自动创建存储桶

    # ========== AWS S3 配置（云存储）==========
    # type: s3
    s3:
      region: us-east-1                 # AWS区域
      access-key: your-access-key       # AWS访问密钥
      secret-key: your-secret-key       # AWS密钥
      bucket: omni-agent                # S3存储桶名称
      endpoint:                         # 自定义端点（可选，用于兼容S3的服务）

    # ========== Redis 配置（缓存式存储）==========
    # type: redis
    redis:
      host: localhost
      port: 6379
      database: 1                       # 使用不同的数据库
      key-prefix: "docs:"                 # 键前缀

    # ========== MongoDB 配置（文档数据库）==========
    # type: mongodb
    mongodb:
      uri: mongodb://localhost:27017
      database: omni-agent-docs
      collection: documents             # 集合名称

    # ========== Elasticsearch 配置（全文索引）==========
    # type: elasticsearch
    elasticsearch:
      hosts:
        - localhost:9200
      index-name: omni-agent-docs       # 索引名称

  # 3. RAG 配置 (Retrieval Augmented Generation)
  # 支持多种后端：file, h2, sqlite, redis, mongodb, elasticsearch
  rag:
    # ========== 当前使用的后端类型 ==========
    type: file

    # ========== File 配置（基于 Lucene）==========
    file:
      index-path: ./data/rag-index      # Lucene索引目录
      analyzer: smartcn                 # 分词器：smartcn(中文), standard(英文)
      max-results: 100                  # 最大返回结果数
      similarity-threshold: 0.7         # 相似度阈值（0.0-1.0）

    # ========== H2 配置（内存/文件数据库）==========
    # type: h2
    h2:
      db-path: ./data/rag-h2
      mode: file                        # file 或 memory
      vector-dimension: 768             # 向量维度
      similarity-metric: cosine         # 相似度度量：cosine, euclidean, dot

    # ========== SQLite 配置（轻量级）==========
    # type: sqlite
    sqlite:
      db-path: ./data/rag-sqlite.db
      vector-dimension: 768
      similarity-metric: cosine

    # ========== Redis 配置（高性能、分布式）==========
    # type: redis
    redis:
      host: localhost
      port: 6379
      database: 2                       # 使用不同的数据库
      key-prefix: "rag:"
      vector-dimension: 768

    # ========== MongoDB 配置（文档数据库 + 向量搜索）==========
    # type: mongodb
    mongodb:
      uri: mongodb://localhost:27017
      database: omni-agent-rag
      collection: vectors               # 向量集合
      index-name: vector_index          # 向量索引名称

    # ========== Elasticsearch 配置（全文搜索 + 向量搜索）==========
    # type: elasticsearch
    elasticsearch:
      hosts:
        - localhost:9200
      index-name: omni-agent-rag        # 索引名称
      vector-dimension: 768
      similarity: cosine                # 相似度算法
      shard-count: 1                    # 分片数
      replica-count: 0                  # 副本数

  # 4. AI 配置 (Artificial Intelligence)
  ai:
    # type: ollama  # 本地Ollama（开发/测试）
    type: online-api    # 在线API（生产环境推荐）

    # Ollama 本地配置（开发/测试环境）
    ollama:
      base-url: http://localhost:11434
      model: qwen2.5:latest
      temperature: 0.7
      max-tokens: 2000
      timeout: 30000  # 30秒

    # Online API 配置（生产环境推荐）⭐
    online:
      # API提供商: qianwen(千问), openai, claude, zhipu(智谱), deepseek
      provider: deepseek

      endpoint: https://api.deepseek.com/v1/chat/completions
      # API基础URL（会自动拼接 /chat/completions）
#      base-url: https://api.deepseek.com/v1

      # API Key（从阿里云DashScope获取）
      # 获取地址: https://dashscope.console.aliyun.com/
      api-key: ${AI_API_KEY:your-api-key-here}

      # 模型选择
      # qwen-plus: 平衡性能和成本（推荐）
      # qwen-turbo: 快速响应
      # qwen-max: 最强性能
      # qwen-vl-plus: 图像理解能力
      default-model: deepseek-chat

      # 生成参数
      temperature: 0.7      # 0.0-2.0，控制随机性
      max-tokens: 2048      # 最大生成token数
      top-p: 0.9           # 核采样参数
      timeout: 60000       # 60秒超时
      max-retries: 3       # 最大重试次数
      stream-enabled: true # 启用流式响应

  # 5. 分块策略配置 (Chunking Strategy) ⭐
  chunking:
    # 默认策略：auto（自动选择）、fixed_size（固定大小）、semantic（语义）、ppl（困惑度）
    default-strategy: ppl

    # PPL 困惑度分块策略配置
    ppl:
      # 模式选择：simplified（简化版，快速）、onnx（ONNX版，精确）、auto（自动选择）
      mode: onnx  # ⭐ 使用 ONNX 模式

      # 自动模式时是否优先精度（为true时会优先使用ONNX）
      prefer-accuracy: true  # ⭐ 优先精度

      # 分块大小范围
      min-chunk-size: 200      # 最小分块大小（字符数）
      max-chunk-size: 800      # 最大分块大小（字符数）

      # 困惑度阈值（0.0-1.0，值越高越严格）
      threshold: 0.3

    # 固定大小分块策略配置（备用）
    fixed-size:
      chunk-size: 500          # 分块大小
      overlap: 50              # 重叠大小

    # 语义分块策略配置（备用）
    semantic:
      min-chunk-size: 200
      max-chunk-size: 1000
      similarity-threshold: 0.75

  # 6. Vision LLM 配置（图片转文字）⭐
  vision-llm:
    # 是否启用图片提取功能
    enabled: true

    # API 配置
    api-key: ${QW_API_KEY:your-api-key-here}

    # 模型选择（支持多模态视觉理解的模型）
    # - qwen-vl-plus: 千问视觉理解增强版（推荐，中文效果好）
    # - qwen-vl-max: 千问视觉理解旗舰版
    # - deepseek-vl: DeepSeek 视觉理解
    # - gpt-4o: OpenAI GPT-4 with Vision
    # - gpt-4-vision-preview: OpenAI GPT-4 Vision
    model: qwen-vl-plus

    # API 端点
    # 千问 VL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
    # DeepSeek VL: https://api.deepseek.com/v1/chat/completions
    # OpenAI: https://api.openai.com/v1/chat/completions
    endpoint: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions

    # ========== 智能批处理配置 ⭐ ==========
    # 根据上下文大小动态决定每批处理多少张幻灯片
    batch-processing:
      # 是否启用智能批处理（根据上下文大小动态分批）
      enabled: true

      # 最大上下文token数（根据模型限制调整）
      # qwen-vl-plus: 8000, qwen-vl-max: 32000, gpt-4o: 128000
      max-context-tokens: 8000

      # 单张幻灯片预估token数（用于预判断）
      # 包括：图片token + 文字token + 提示词token
      estimated-tokens-per-slide: 1500

      # 预留token数（用于系统提示词和响应）
      reserved-tokens: 2000

      # 最小批次大小（至少处理多少张）
      min-batch-size: 1

      # 最大批次大小（最多处理多少张）
      max-batch-size: 5

    # 系统提示词（可自定义）
    system-prompt: |
      请分析这张图片并提取其中的关键信息。
      如果图片包含文字，请完整准确地提取所有文字内容。
      如果是图表或示意图，请描述其主要内容和含义。
      
      【重要】对于包含多张图片的幻灯片：
      - 这些图片可能是一个完整内容的不同部分（如流程图、架构图、部署图）
      - 请综合分析所有图片，理解它们的整体含义和关联关系
      - 图片按空间位置排列（从上到下，从左到右）
      
      保持输出简洁，只提取核心信息。

  # ========== 线程池配置（统一管理）⭐ ==========
  thread-pool:
    # Vision LLM 处理线程池
    vision-llm:
      core-pool-size: 2           # 核心线程数
      max-pool-size: 4            # 最大线程数
      queue-capacity: 100         # 队列容量
      keep-alive-seconds: 60      # 空闲线程存活时间
      thread-name-prefix: "vision-llm-"
      allow-core-thread-timeout: true
      wait-for-tasks-to-complete-on-shutdown: true
      await-termination-seconds: 60

    # 文件监听器线程池
    file-watcher:
      core-pool-size: 1           # 核心线程数
      max-pool-size: 2            # 最大线程数
      queue-capacity: 50          # 队列容量
      keep-alive-seconds: 300     # 空闲线程存活时间（5分钟）
      thread-name-prefix: "file-watcher-"
      allow-core-thread-timeout: true
      wait-for-tasks-to-complete-on-shutdown: true
      await-termination-seconds: 30

  # ========== 文件监听器配置 ⭐ ==========
  file-watcher:
    enabled: true                       # 启用文件监听
    watch-directory: ./data/documents   # 监听目录（上传文件会保存到这里）
    auto-index: true                    # 自动索引
    scan-interval: 30000                # 扫描间隔（毫秒）

# ========== 日志配置 ==========
logging:
  level:
    top.yumbo.ai: DEBUG  # 启用所有 debug 日志
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
