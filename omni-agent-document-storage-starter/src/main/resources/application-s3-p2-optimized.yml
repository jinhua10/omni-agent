# ✅ S3存储 - P2优化配置示例
#
# 包含以下优化：
# - P0优化：并行流、批量API、实现缺失方法
# - P1优化：重试机制、分页统计
# - P2优化：传输加速、连接池优化、监控指标
#
# @author OmniAgent Team
# @since 3.0.0
# @version P2 Optimized

spring:
  # ✅ P1优化：重试机制配置
  retry:
    s3:
      enabled: true
      max-attempts: 3           # 最大重试次数
      initial-interval: 100ms   # 初始延迟
      multiplier: 2.0          # 延迟倍增系数
      max-interval: 2000ms     # 最大延迟

# OmniAgent文档存储配置
omni-agent:
  document-storage:
    # 存储类型选择
    type: s3

    # 主实例配置
    primary: s3-main

    # 实例列表
    instances:
      s3-main:
        type: s3
        s3:
          # 基础配置
          bucket-name: omni-agent-storage
          region: us-east-1

          # 认证配置
          access-key: ${AWS_ACCESS_KEY_ID:your-access-key}
          secret-key: ${AWS_SECRET_ACCESS_KEY:your-secret-key}

          # ✅ P2优化1：启用S3传输加速
          # 传输加速可以提升跨地域上传下载速度
          transfer-acceleration:
            enabled: true

          # ✅ P2优化2：连接池配置
          client:
            # HTTP客户端配置
            http:
              # 最大连接数
              max-connections: 100
              # 每个路由的最大连接数
              max-per-route: 50
              # 连接超时
              connection-timeout: 10s
              # Socket超时
              socket-timeout: 30s
              # 请求超时
              request-timeout: 60s
              # 连接空闲超时
              connection-idle-timeout: 60s
              # 连接生命周期
              connection-time-to-live: 300s
              # 连接获取超时
              connection-acquisition-timeout: 10s

            # ✅ P2优化：异步配置（提升并发性能）
            async:
              enabled: true
              # 最大并发请求数
              max-concurrency: 50
              # 最大等待请求数
              max-pending-connection-acquires: 10000

          # ✅ P2优化：分段上传配置（大文件优化）
          multipart:
            # 启用分段上传
            enabled: true
            # 分段大小（建议5MB-100MB）
            part-size: 10MB
            # 分段上传阈值（超过此大小使用分段上传）
            threshold: 10MB
            # 最小分段大小
            minimum-part-size: 5MB

          # ✅ P2优化：重试策略
          retry:
            # 模式：standard, adaptive
            mode: adaptive
            # 最大重试次数
            max-attempts: 3
            # 基础延迟
            base-delay: 100ms
            # 最大退避时间
            max-backoff-time: 20s
            # 重试条件
            retry-on-throttling: true
            retry-on-service-unavailable: true

          # ✅ P2优化3：监控指标
          metrics:
            enabled: true
            # 记录详细指标
            detailed: true
            # 指标前缀
            prefix: s3.storage
            # 记录的操作类型
            operations:
              - PUT_OBJECT
              - GET_OBJECT
              - DELETE_OBJECT
              - LIST_OBJECTS
              - DELETE_OBJECTS

# ✅ P2优化：监控和指标导出
management:
  metrics:
    enable:
      s3: true
    export:
      # Prometheus导出（可选）
      prometheus:
        enabled: true
      # JMX导出
      jmx:
        enabled: true
    tags:
      application: omni-agent
      storage: s3

  endpoint:
    health:
      show-details: always

  # 健康检查
  health:
    s3:
      enabled: true

# 日志配置（可选）
logging:
  level:
    top.yumbo.ai.omni.storage.impl.s3: DEBUG
    software.amazon.awssdk.services.s3: INFO
    org.springframework.retry: DEBUG

# ✅ P2优化：AWS SDK配置
aws:
  s3:
    # 使用路径样式访问（兼容MinIO等S3兼容存储）
    path-style-access: false

    # 签名版本
    signature-version: AWS4-HMAC-SHA256

    # 分块编码
    chunked-encoding: true

    # 加速端点（传输加速）
    # 格式: bucket-name.s3-accelerate.amazonaws.com
    # accelerate-endpoint: ${omni-agent.document-storage.instances.s3-main.s3.bucket-name}.s3-accelerate.amazonaws.com

# =========================================
# 配置说明和调优建议
# =========================================

# 1. 传输加速配置
# - 启用条件：跨地域访问、需要更快的上传下载速度
# - 注意：需要在S3 Bucket上启用传输加速功能
# - 费用：传输加速会产生额外费用
# - 适用场景：
#   - 跨大洲数据传输
#   - 需要低延迟的应用
#   - 大文件上传下载

# 2. 连接池配置调优
# - max-connections: 根据并发量调整
#   - 低并发（<10）：50
#   - 中等并发（10-50）：100
#   - 高并发（50-200）：200-500
# - connection-timeout: 根据网络状况
#   - 内网/同区域：5-10s
#   - 跨区域：10-30s
#   - 国际网络：30-60s

# 3. 分段上传配置
# - part-size建议：
#   - 小文件（<100MB）：5-10MB
#   - 中等文件（100MB-1GB）：10-50MB
#   - 大文件（>1GB）：50-100MB
# - threshold设置：
#   - 一般设置为part-size的1-2倍
#   - 建议不小于5MB（S3最小分段大小）

# 4. 重试策略
# - adaptive模式：根据错误类型自动调整
# - standard模式：固定重试策略
# - 推荐使用adaptive模式

# 5. 监控指标
# - 记录的关键指标：
#   - 请求延迟（latency）
#   - 请求成功率（success_rate）
#   - 重试次数（retry_count）
#   - 传输速率（throughput）
#   - 错误类型分布

# =========================================
# 生产环境配置示例
# =========================================

---
# 生产环境配置
spring:
  config:
    activate:
      on-profile: production

omni-agent:
  document-storage:
    instances:
      s3-main:
        s3:
          # 使用环境变量
          access-key: ${AWS_ACCESS_KEY_ID}
          secret-key: ${AWS_SECRET_ACCESS_KEY}

          # 生产环境优化配置
          transfer-acceleration:
            enabled: true

          client:
            http:
              max-connections: 200
              connection-timeout: 10s
              socket-timeout: 30s

          multipart:
            enabled: true
            part-size: 20MB
            threshold: 20MB

          retry:
            mode: adaptive
            max-attempts: 3

          metrics:
            enabled: true
            detailed: true

---
# 开发环境配置
spring:
  config:
    activate:
      on-profile: development

omni-agent:
  document-storage:
    instances:
      s3-main:
        s3:
          # 开发环境使用本地MinIO
          endpoint: http://localhost:9000

          transfer-acceleration:
            enabled: false  # MinIO不支持传输加速

          client:
            http:
              max-connections: 50
              connection-timeout: 5s

          multipart:
            enabled: true
            part-size: 10MB

          metrics:
            enabled: true
            detailed: false

# =========================================
# 性能基准测试配置
# =========================================

# 测试场景1：高并发上传
# - max-connections: 200
# - max-concurrency: 100
# - part-size: 10MB
# - 预期：500个文件/分钟

# 测试场景2：大文件传输
# - transfer-acceleration: true
# - part-size: 50MB
# - max-connections: 100
# - 预期：100MB/s上传速度

# 测试场景3：跨地域访问
# - transfer-acceleration: true
# - retry.mode: adaptive
# - connection-timeout: 30s
# - 预期：延迟降低30-50%

